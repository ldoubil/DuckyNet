# DuckyNet é€€å‡ºæˆ¿é—´å’Œæ–­å¼€è¿æ¥æ¸…ç†é€»è¾‘æ£€æŸ¥æŠ¥å‘Š

## ğŸ” æ£€æŸ¥æ—¶é—´
2025-11-07

## ğŸ“Š æ£€æŸ¥èŒƒå›´
- âœ… æœåŠ¡ç«¯æ–­å¼€è¿æ¥å¤„ç†
- âœ… æœåŠ¡ç«¯ç¦»å¼€æˆ¿é—´å¤„ç†  
- âœ… å®¢æˆ·ç«¯æ–­å¼€è¿æ¥å¤„ç†
- âœ… å®¢æˆ·ç«¯ç¦»å¼€æˆ¿é—´å¤„ç†
- âœ… å„ç±»ç¼“å­˜æ•°æ®æ¸…ç†
- âœ… ç©å®¶çŠ¶æ€æ•°æ®æ¸…ç†

---

## ğŸš¨ å‘ç°çš„ä¸¥é‡é—®é¢˜

### âŒ **é—®é¢˜1: è£…å¤‡æ•°æ®æœªæ¸…ç†ï¼ˆé«˜å±ï¼‰**

**æ–‡ä»¶**: `Server/Services/EquipmentServerServiceImpl.cs`

**é—®é¢˜æè¿°**:
- âœ… è£…å¤‡æ•°æ®å­˜å‚¨åœ¨ `PlayerInfo.EquipmentData` ä¸­
- âŒ **æ²¡æœ‰ `ClearPlayerEquipment()` æ–¹æ³•**
- âŒ ç©å®¶ç¦»å¼€æˆ¿é—´æ—¶è£…å¤‡æ•°æ®**æœªè¢«æ¸…ç†**
- âŒ ç©å®¶æ–­å¼€è¿æ¥æ—¶è£…å¤‡æ•°æ®**æœªè¢«æ¸…ç†**

**å½±å“**:
```csharp
// åœºæ™¯ï¼šç©å®¶Aè£…å¤‡äº†å…¨å¥—è£…å¤‡ï¼Œç„¶åç¦»å¼€æˆ¿é—´
1. ç©å®¶Aè°ƒç”¨ LeaveRoomAsync()
2. æœåŠ¡ç«¯æ¸…ç†æˆ¿é—´çŠ¶æ€ï¼Œä½† PlayerInfo.EquipmentData ä¿ç•™
3. ç©å®¶Aé‡æ–°åŠ å…¥æˆ¿é—´
4. æˆ¿é—´å†…å…¶ä»–ç©å®¶ä¼šæ”¶åˆ°ç©å®¶Açš„æ—§è£…å¤‡æ•°æ®ï¼ˆå³ä½¿ç©å®¶Aå·²å¸ä¸‹è£…å¤‡ï¼‰
```

**é£é™©ç­‰çº§**: ğŸ”´ **é«˜** - å¯¼è‡´è£…å¤‡çŠ¶æ€ä¸ä¸€è‡´

---

### âŒ **é—®é¢˜2: æ­¦å™¨æ•°æ®æœªæ¸…ç†ï¼ˆé«˜å±ï¼‰**

**æ–‡ä»¶**: `Server/Services/WeaponSyncServerServiceImpl.cs`

**é—®é¢˜æè¿°**:
- âœ… æ­¦å™¨æ•°æ®å­˜å‚¨åœ¨ `PlayerInfo.WeaponData` ä¸­
- âŒ **æ²¡æœ‰ `ClearPlayerWeapon()` æ–¹æ³•**
- âŒ ç©å®¶ç¦»å¼€æˆ¿é—´æ—¶æ­¦å™¨æ•°æ®**æœªè¢«æ¸…ç†**
- âŒ ç©å®¶æ–­å¼€è¿æ¥æ—¶æ­¦å™¨æ•°æ®**æœªè¢«æ¸…ç†**

**å½±å“**:
```csharp
// åœºæ™¯ï¼šç©å®¶Aè£…å¤‡äº†AK47ï¼Œç„¶åç¦»å¼€æˆ¿é—´
1. ç©å®¶Aè°ƒç”¨ LeaveRoomAsync()
2. æœåŠ¡ç«¯æ¸…ç†æˆ¿é—´çŠ¶æ€ï¼Œä½† PlayerInfo.WeaponData ä¿ç•™
3. ç©å®¶Aé‡æ–°åŠ å…¥æˆ¿é—´
4. æˆ¿é—´å†…å…¶ä»–ç©å®¶ä¼šæ”¶åˆ°ç©å®¶Açš„æ—§æ­¦å™¨æ•°æ®ï¼ˆå³ä½¿ç©å®¶Aå·²åˆ‡æ¢æ­¦å™¨ï¼‰
```

**é£é™©ç­‰çº§**: ğŸ”´ **é«˜** - å¯¼è‡´æ­¦å™¨çŠ¶æ€ä¸ä¸€è‡´

---

### âŒ **é—®é¢˜3: å¤–è§‚æ•°æ®æœªæ¸…ç†ï¼ˆä¸­å±ï¼‰**

**æ–‡ä»¶**: `Shared/Services/IPlayerService.cs` (PlayerInfo å®šä¹‰)

**é—®é¢˜æè¿°**:
- âœ… å¤–è§‚æ•°æ®å­˜å‚¨åœ¨ `PlayerInfo.AppearanceData` ä¸­
- âŒ **æ²¡æœ‰ä¸“é—¨çš„æ¸…ç†é€»è¾‘**
- âŒ ç©å®¶ç¦»å¼€æˆ¿é—´æ—¶å¤–è§‚æ•°æ®**æœªè¢«æ¸…ç†**

**å½±å“**:
- ç©å®¶ç¦»å¼€æˆ¿é—´åé‡æ–°åŠ å…¥ï¼Œå¤–è§‚æ•°æ®å¯èƒ½è¿‡æœŸ
- å¦‚æœç©å®¶åœ¨æˆ¿é—´å¤–æ›´æ”¹äº†å¤–è§‚ï¼Œé‡æ–°åŠ å…¥æ—¶ä¼šæ˜¾ç¤ºæ—§å¤–è§‚

**é£é™©ç­‰çº§**: ğŸŸ¡ **ä¸­** - å¤–è§‚æ•°æ®é€šå¸¸åœ¨è¿›å…¥åœºæ™¯æ—¶é‡æ–°ä¸Šä¼ ï¼Œå½±å“è¾ƒå°

---

### âš ï¸ **é—®é¢˜4: æœåŠ¡ç«¯æ–­å¼€è¿æ¥æ¸…ç†ä¸å½»åº•**

**æ–‡ä»¶**: `Server/Managers/PlayerManager.cs` ç¬¬120-141è¡Œ

**å½“å‰å®ç°**:
```csharp
public void OnClientDisconnected(string ClientId)
{
    lock (_lock)
    {
        if (_playersByClientId.TryGetValue(ClientId, out var player))
        {
            _playersByClientId.Remove(ClientId);         // âœ… æ¸…ç†
            _playersBySteamId.Remove(player.SteamId);    // âœ… æ¸…ç†
            _roomManager?.LeaveRoom(player);             // âœ… æ¸…ç†æˆ¿é—´çŠ¶æ€
        }
        else
        {
            _pendingConnections.Remove(ClientId);        // âœ… æ¸…ç†å¾…ç™»å½•
        }
    }
}
```

**ç¼ºå°‘çš„æ¸…ç†**:
```csharp
// âŒ æœªè°ƒç”¨ï¼šæ¸…é™¤ä½ç½®ç¼“å­˜
_unitySyncService?.ClearPlayerPosition(player.SteamId);

// âŒ æœªè°ƒç”¨ï¼šæ¸…é™¤è¡€é‡ç¼“å­˜
_healthSyncService?.ClearPlayerHealth(player.SteamId);

// âŒ æœªè°ƒç”¨ï¼šæ¸…é™¤åœºæ™¯æ•°æ®
_playerManager.UpdatePlayerSceneDataByClientId(ClientId, new ScenelData("", ""));

// âŒ æœªè°ƒç”¨ï¼šæ¸…é™¤è£…å¤‡æ•°æ®
player.EquipmentData = new PlayerEquipmentData();

// âŒ æœªè°ƒç”¨ï¼šæ¸…é™¤æ­¦å™¨æ•°æ®
player.WeaponData = null;

// âŒ æœªè°ƒç”¨ï¼šæ¸…é™¤å¤–è§‚æ•°æ®
player.AppearanceData = null;
```

**é£é™©ç­‰çº§**: ğŸ”´ **é«˜** - æ–­çº¿é‡è¿åçŠ¶æ€æ®‹ç•™

---

### âš ï¸ **é—®é¢˜5: æœåŠ¡ç«¯ç¦»å¼€æˆ¿é—´æ¸…ç†ä¸å®Œæ•´**

**æ–‡ä»¶**: `Server/Services/RoomServiceImpl.cs` ç¬¬268-315è¡Œ

**å½“å‰å®ç°**:
```csharp
public async Task<bool> LeaveRoomAsync(IClientContext client)
{
    var player = _playerManager.GetPlayer(client.ClientId);
    if (player == null) return false;

    var room = _roomManager.LeaveRoom(player);

    if (room != null)
    {
        // âœ… æ¸…é™¤ä½ç½®ç¼“å­˜
        _unitySyncService.ClearPlayerPosition(player.SteamId);
        
        // âœ… æ¸…é™¤åœºæ™¯æ•°æ®
        _playerManager.UpdatePlayerSceneDataByClientId(client.ClientId, new ScenelData("", ""));
        
        // å‘å¸ƒäº‹ä»¶å’Œé€šçŸ¥å…¶ä»–ç©å®¶
        // ...
    }

    return await Task.FromResult(true);
}
```

**ç¼ºå°‘çš„æ¸…ç†**:
```csharp
// âŒ æœªè°ƒç”¨ï¼šæ¸…é™¤è¡€é‡ç¼“å­˜
_healthSyncService?.ClearPlayerHealth(player.SteamId);

// âŒ æœªè°ƒç”¨ï¼šæ¸…é™¤è£…å¤‡æ•°æ®ï¼ˆåº”è¯¥ç”± EquipmentService æä¾›æ–¹æ³•ï¼‰
// ä¾‹å¦‚ï¼š_equipmentService?.ClearPlayerEquipment(player.SteamId);

// âŒ æœªè°ƒç”¨ï¼šæ¸…é™¤æ­¦å™¨æ•°æ®ï¼ˆåº”è¯¥ç”± WeaponSyncService æä¾›æ–¹æ³•ï¼‰
// ä¾‹å¦‚ï¼š_weaponSyncService?.ClearPlayerWeapon(player.SteamId);
```

**é£é™©ç­‰çº§**: ğŸŸ¡ **ä¸­** - ç¦»å¼€æˆ¿é—´åé‡æ–°åŠ å…¥å¯èƒ½æœ‰æ•°æ®æ®‹ç•™

---

### âœ… **æ­£ç¡®å®ç°: ä½ç½®ç¼“å­˜æ¸…ç†**

**æ–‡ä»¶**: `Server/Services/PlayerUnitySyncServiceImpl.cs` ç¬¬50-62è¡Œ

```csharp
/// <summary>
/// æ¸…é™¤ç©å®¶çš„ä½ç½®ç¼“å­˜ï¼ˆç©å®¶ç¦»å¼€æˆ¿é—´/æ–­å¼€è¿æ¥æ—¶è°ƒç”¨ï¼‰
/// </summary>
public void ClearPlayerPosition(string steamId)
{
    lock (_lock)
    {
        if (_lastPositionCache.Remove(steamId))
        {
            Console.WriteLine($"[PlayerUnitySyncService] æ¸…é™¤ç©å®¶ {steamId} çš„ä½ç½®ç¼“å­˜");
        }
    }
}
```

**è°ƒç”¨æƒ…å†µ**:
- âœ… `RoomServiceImpl.LeaveRoomAsync` ä¸­è¢«è°ƒç”¨ï¼ˆç¬¬286è¡Œï¼‰
- âŒ `PlayerManager.OnClientDisconnected` ä¸­**æœªè¢«è°ƒç”¨**

---

### âœ… **æ­£ç¡®å®ç°: è¡€é‡ç¼“å­˜æ¸…ç†**

**æ–‡ä»¶**: `Server/Services/HealthSyncServiceImpl.cs` ç¬¬49-61è¡Œ

```csharp
/// <summary>
/// æ¸…é™¤ç©å®¶çš„è¡€é‡ç¼“å­˜ï¼ˆç©å®¶ç¦»å¼€æˆ¿é—´/æ–­å¼€è¿æ¥æ—¶è°ƒç”¨ï¼‰
/// </summary>
public void ClearPlayerHealth(string steamId)
{
    lock (_lock)
    {
        if (_lastHealthCache.Remove(steamId))
        {
            Console.WriteLine($"[HealthSyncService] æ¸…é™¤ç©å®¶ {steamId} çš„è¡€é‡ç¼“å­˜");
        }
    }
}
```

**è°ƒç”¨æƒ…å†µ**:
- âŒ `RoomServiceImpl.LeaveRoomAsync` ä¸­**æœªè¢«è°ƒç”¨**
- âŒ `PlayerManager.OnClientDisconnected` ä¸­**æœªè¢«è°ƒç”¨**

---

### âš ï¸ **é—®é¢˜6: å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ¸…ç†**

**æ–‡ä»¶**: `Client/Core/NetworkLifecycleManager.cs` ç¬¬50-67è¡Œ

**å½“å‰å®ç°**:
```csharp
public void HandleDisconnected(string reason)
{
    try
    {
        Debug.LogWarning($"[NetworkLifecycleManager] ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥: {reason}");

        // å‘å¸ƒ EventBus äº‹ä»¶
        if (GameContext.IsInitialized)
        {
            _context.EventBus.Publish(new NetworkDisconnectedEvent(reason));
        }
    }
    catch (Exception ex)
    {
        Debug.LogError($"[NetworkLifecycleManager] å¤„ç†æ–­å¼€è¿æ¥äº‹ä»¶å¤±è´¥: {ex.Message}");
    }
}
```

**é—®é¢˜**:
- âœ… å‘å¸ƒäº† `NetworkDisconnectedEvent` äº‹ä»¶
- â“ éœ€è¦æ£€æŸ¥å“ªäº›æ¨¡å—è®¢é˜…äº†è¿™ä¸ªäº‹ä»¶å¹¶è¿›è¡Œæ¸…ç†

**æ£€æŸ¥ç»“æœ** (`Client/Core/RoomManager.cs` ç¬¬214-220è¡Œ):
```csharp
private void OnNetworkDisconnected(NetworkDisconnectedEvent evt)
{
    Debug.Log($"[RoomManager] ğŸ”¥ ç½‘ç»œæ–­å¼€è¿æ¥ï¼Œæ¸…ç†æˆ¿é—´çŠ¶æ€: {evt.Reason}");
    CurrentRoom = null;         // âœ… æ¸…ç†å½“å‰æˆ¿é—´
    RoomPlayers.Clear();        // âœ… æ¸…ç†ç©å®¶åˆ—è¡¨
    Debug.Log($"[RoomManager] âœ… æˆ¿é—´çŠ¶æ€å·²æ¸…ç†");
}
```

**ç¼ºå°‘çš„æ£€æŸ¥**:
- â“ `PlayerManager` æ˜¯å¦æ¸…ç†äº†æœ¬åœ°ç©å®¶å’Œè¿œç¨‹ç©å®¶åˆ—è¡¨ï¼Ÿ
- â“ `SceneClientManager` æ˜¯å¦æ¸…ç†äº†åœºæ™¯çŠ¶æ€ï¼Ÿ
- â“ `AnimatorSyncManager` æ˜¯å¦æ¸…ç†äº†åŠ¨ç”»åŒæ­¥çŠ¶æ€ï¼Ÿ
- â“ `ItemNetworkCoordinator` æ˜¯å¦æ¸…ç†äº†ç‰©å“åŒæ­¥çŠ¶æ€ï¼Ÿ

---

## ğŸ“‹ å®Œæ•´çš„æ¸…ç†éœ€æ±‚æ¸…å•

### æœåŠ¡ç«¯æ–­å¼€è¿æ¥æ—¶åº”æ¸…ç†ï¼š

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | æ˜¯å¦æ¸…ç† | æ¸…ç†æ–¹æ³• |
|---------|---------|---------|---------|
| ClientId æ˜ å°„ | `_playersByClientId` | âœ… å·²æ¸…ç† | `PlayerManager.OnClientDisconnected` |
| SteamId æ˜ å°„ | `_playersBySteamId` | âœ… å·²æ¸…ç† | `PlayerManager.OnClientDisconnected` |
| æˆ¿é—´çŠ¶æ€ | `_playerRoom`, `_roomPlayers` | âœ… å·²æ¸…ç† | `RoomManager.LeaveRoom` |
| ä½ç½®ç¼“å­˜ | `_lastPositionCache` | âŒ **æœªæ¸…ç†** | éœ€è¦è°ƒç”¨ `ClearPlayerPosition` |
| è¡€é‡ç¼“å­˜ | `_lastHealthCache` | âŒ **æœªæ¸…ç†** | éœ€è¦è°ƒç”¨ `ClearPlayerHealth` |
| åœºæ™¯æ•°æ® | `PlayerInfo.CurrentScenelData` | âŒ **æœªæ¸…ç†** | éœ€è¦è°ƒç”¨ `UpdatePlayerSceneDataByClientId` |
| è£…å¤‡æ•°æ® | `PlayerInfo.EquipmentData` | âŒ **æœªæ¸…ç†** | **ç¼ºå°‘æ¸…ç†æ–¹æ³•** |
| æ­¦å™¨æ•°æ® | `PlayerInfo.WeaponData` | âŒ **æœªæ¸…ç†** | **ç¼ºå°‘æ¸…ç†æ–¹æ³•** |
| å¤–è§‚æ•°æ® | `PlayerInfo.AppearanceData` | âŒ **æœªæ¸…ç†** | **ç¼ºå°‘æ¸…ç†æ–¹æ³•** |

### æœåŠ¡ç«¯ç¦»å¼€æˆ¿é—´æ—¶åº”æ¸…ç†ï¼š

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | æ˜¯å¦æ¸…ç† | æ¸…ç†æ–¹æ³• |
|---------|---------|---------|---------|
| æˆ¿é—´çŠ¶æ€ | `_playerRoom`, `_roomPlayers` | âœ… å·²æ¸…ç† | `RoomManager.LeaveRoom` |
| ä½ç½®ç¼“å­˜ | `_lastPositionCache` | âœ… **å·²æ¸…ç†** | `ClearPlayerPosition` |
| åœºæ™¯æ•°æ® | `PlayerInfo.CurrentScenelData` | âœ… **å·²æ¸…ç†** | `UpdatePlayerSceneDataByClientId` |
| è¡€é‡ç¼“å­˜ | `_lastHealthCache` | âŒ **æœªæ¸…ç†** | éœ€è¦è°ƒç”¨ `ClearPlayerHealth` |
| è£…å¤‡æ•°æ® | `PlayerInfo.EquipmentData` | âŒ **æœªæ¸…ç†** | **ç¼ºå°‘æ¸…ç†æ–¹æ³•** |
| æ­¦å™¨æ•°æ® | `PlayerInfo.WeaponData` | âŒ **æœªæ¸…ç†** | **ç¼ºå°‘æ¸…ç†æ–¹æ³•** |
| å¤–è§‚æ•°æ® | `PlayerInfo.AppearanceData` | âŒ **æœªæ¸…ç†** | **ç¼ºå°‘æ¸…ç†æ–¹æ³•** |

### å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶åº”æ¸…ç†ï¼š

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | æ˜¯å¦æ¸…ç† | è®¢é˜…è€… |
|---------|---------|---------|--------|
| å½“å‰æˆ¿é—´ | `RoomManager.CurrentRoom` | âœ… å·²æ¸…ç† | `RoomManager.OnNetworkDisconnected` |
| æˆ¿é—´ç©å®¶åˆ—è¡¨ | `RoomManager.RoomPlayers` | âœ… å·²æ¸…ç† | `RoomManager.OnNetworkDisconnected` |
| è¿œç¨‹ç©å®¶å¯¹è±¡ | `PlayerManager.RemotePlayers` | â“ **éœ€æ£€æŸ¥** | éœ€è¦æ£€æŸ¥ `PlayerManager` æ˜¯å¦è®¢é˜… |
| åœºæ™¯çŠ¶æ€ | `SceneClientManager._scenelDataList` | â“ **éœ€æ£€æŸ¥** | éœ€è¦æ£€æŸ¥æ˜¯å¦è®¢é˜… |
| åŠ¨ç”»åŒæ­¥çŠ¶æ€ | `AnimatorSyncManager` | â“ **éœ€æ£€æŸ¥** | éœ€è¦æ£€æŸ¥æ˜¯å¦è®¢é˜… |

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ·»åŠ ç¼ºå¤±çš„æ¸…ç†æ–¹æ³•

#### 1.1 EquipmentServerServiceImpl æ·»åŠ æ¸…ç†æ–¹æ³•

```csharp
// æ–‡ä»¶: Server/Services/EquipmentServerServiceImpl.cs

/// <summary>
/// æ¸…é™¤ç©å®¶çš„è£…å¤‡æ•°æ®ï¼ˆç©å®¶ç¦»å¼€æˆ¿é—´/æ–­å¼€è¿æ¥æ—¶è°ƒç”¨ï¼‰
/// </summary>
public void ClearPlayerEquipment(string steamId)
{
    try
    {
        var player = _playerManager.GetPlayerBySteamId(steamId);
        if (player != null)
        {
            player.EquipmentData = new PlayerEquipmentData();
            Log($"æ¸…é™¤ç©å®¶ {steamId} çš„è£…å¤‡æ•°æ®", ConsoleColor.Yellow);
        }
    }
    catch (Exception ex)
    {
        Log($"ClearPlayerEquipment å¤±è´¥: {ex.Message}", ConsoleColor.Red);
    }
}
```

#### 1.2 WeaponSyncServerServiceImpl æ·»åŠ æ¸…ç†æ–¹æ³•

```csharp
// æ–‡ä»¶: Server/Services/WeaponSyncServerServiceImpl.cs

/// <summary>
/// æ¸…é™¤ç©å®¶çš„æ­¦å™¨æ•°æ®ï¼ˆç©å®¶ç¦»å¼€æˆ¿é—´/æ–­å¼€è¿æ¥æ—¶è°ƒç”¨ï¼‰
/// </summary>
public void ClearPlayerWeapon(string steamId)
{
    try
    {
        var player = _playerManager.GetPlayerBySteamId(steamId);
        if (player != null)
        {
            player.WeaponData = null;
            Log($"æ¸…é™¤ç©å®¶ {steamId} çš„æ­¦å™¨æ•°æ®", ConsoleColor.Yellow);
        }
    }
    catch (Exception ex)
    {
        Log($"ClearPlayerWeapon å¤±è´¥: {ex.Message}", ConsoleColor.Red);
    }
}
```

---

### æ–¹æ¡ˆ2: ä¿®å¤ PlayerManager.OnClientDisconnected

```csharp
// æ–‡ä»¶: Server/Managers/PlayerManager.cs

public void OnClientDisconnected(string ClientId)
{
    lock (_lock)
    {
        if (_playersByClientId.TryGetValue(ClientId, out var player))
        {
            Console.WriteLine($"[PlayerManager] Player disconnected: {player.SteamName}");
            
            // 1. ä»æˆ¿é—´ç§»é™¤
            _roomManager?.LeaveRoom(player);
            
            // 2. æ¸…ç†æ‰€æœ‰ç¼“å­˜æ•°æ®ï¼ˆéœ€è¦æ³¨å…¥è¿™äº›æœåŠ¡ï¼‰
            // TODO: éœ€è¦åœ¨æ„é€ å‡½æ•°ä¸­æ³¨å…¥è¿™äº›æœåŠ¡
            // _unitySyncService?.ClearPlayerPosition(player.SteamId);
            // _healthSyncService?.ClearPlayerHealth(player.SteamId);
            // _equipmentService?.ClearPlayerEquipment(player.SteamId);
            // _weaponSyncService?.ClearPlayerWeapon(player.SteamId);
            
            // 3. æ¸…ç†åœºæ™¯æ•°æ®
            UpdatePlayerSceneDataByClientId(ClientId, new ScenelData("", ""));
            
            // 4. æ¸…ç†æ˜ å°„
            _playersByClientId.Remove(ClientId);
            _playersBySteamId.Remove(player.SteamId);
        }
        else
        {
            _pendingConnections.Remove(ClientId);
        }
    }
}
```

**é—®é¢˜**: `PlayerManager` éœ€è¦ä¾èµ–å¤ªå¤šæœåŠ¡ï¼Œè¿åå•ä¸€èŒè´£åŸåˆ™ã€‚

---

### æ–¹æ¡ˆ3: ä½¿ç”¨äº‹ä»¶é€šçŸ¥æ¸…ç†ï¼ˆæ¨èï¼‰

#### 3.1 åˆ›å»ºç©å®¶æ–­å¼€è¿æ¥äº‹ä»¶

```csharp
// æ–‡ä»¶: Server/Events/PlayerDisconnectedEvent.cs

public class PlayerDisconnectedEvent
{
    public string ClientId { get; set; }
    public PlayerInfo Player { get; set; }
}
```

#### 3.2 åœ¨ PlayerManager ä¸­å‘å¸ƒäº‹ä»¶

```csharp
// æ–‡ä»¶: Server/Managers/PlayerManager.cs

public void OnClientDisconnected(string ClientId)
{
    lock (_lock)
    {
        if (_playersByClientId.TryGetValue(ClientId, out var player))
        {
            // å‘å¸ƒäº‹ä»¶ï¼ˆè®©å„ä¸ªæœåŠ¡è‡ªè¡Œæ¸…ç†ï¼‰
            ServerEventPublisher.PublishPlayerDisconnected(ClientId, player);
            
            // ä»æˆ¿é—´ç§»é™¤
            _roomManager?.LeaveRoom(player);
            
            // æ¸…ç†æ˜ å°„
            _playersByClientId.Remove(ClientId);
            _playersBySteamId.Remove(player.SteamId);
        }
        else
        {
            _pendingConnections.Remove(ClientId);
        }
    }
}
```

#### 3.3 å„æœåŠ¡è®¢é˜…äº‹ä»¶å¹¶æ¸…ç†

```csharp
// æ–‡ä»¶: Server/Services/PlayerUnitySyncServiceImpl.cs

public PlayerUnitySyncServiceImpl(RpcServer server, PlayerManager playerManager, RoomManager roomManager)
{
    _server = server;
    _playerManager = playerManager;
    _roomManager = roomManager;
    
    // è®¢é˜…ç©å®¶æ–­å¼€è¿æ¥äº‹ä»¶
    ServerEventPublisher.EventBus.Subscribe<PlayerDisconnectedEvent>(OnPlayerDisconnected);
}

private void OnPlayerDisconnected(PlayerDisconnectedEvent evt)
{
    ClearPlayerPosition(evt.Player.SteamId);
}
```

```csharp
// æ–‡ä»¶: Server/Services/HealthSyncServiceImpl.cs

public HealthSyncServiceImpl(RpcServer server, PlayerManager playerManager, RoomManager roomManager)
{
    _server = server;
    _playerManager = playerManager;
    _roomManager = roomManager;
    
    // è®¢é˜…ç©å®¶æ–­å¼€è¿æ¥äº‹ä»¶
    ServerEventPublisher.EventBus.Subscribe<PlayerDisconnectedEvent>(OnPlayerDisconnected);
}

private void OnPlayerDisconnected(PlayerDisconnectedEvent evt)
{
    ClearPlayerHealth(evt.Player.SteamId);
}
```

---

### æ–¹æ¡ˆ4: ä¿®å¤ RoomServiceImpl.LeaveRoomAsync

```csharp
// æ–‡ä»¶: Server/Services/RoomServiceImpl.cs

public async Task<bool> LeaveRoomAsync(IClientContext client)
{
    var player = _playerManager.GetPlayer(client.ClientId);
    if (player == null) return false;

    var room = _roomManager.LeaveRoom(player);

    if (room != null)
    {
        // âœ… æ¸…é™¤ä½ç½®ç¼“å­˜
        _unitySyncService.ClearPlayerPosition(player.SteamId);
        
        // âœ… æ¸…é™¤åœºæ™¯æ•°æ®
        _playerManager.UpdatePlayerSceneDataByClientId(client.ClientId, new ScenelData("", ""));
        
        // ğŸ”¥ æ–°å¢ï¼šæ¸…é™¤è¡€é‡ç¼“å­˜
        // _healthSyncService?.ClearPlayerHealth(player.SteamId);
        
        // ğŸ”¥ æ–°å¢ï¼šæ¸…é™¤è£…å¤‡æ•°æ®
        // _equipmentService?.ClearPlayerEquipment(player.SteamId);
        
        // ğŸ”¥ æ–°å¢ï¼šæ¸…é™¤æ­¦å™¨æ•°æ®
        // _weaponSyncService?.ClearPlayerWeapon(player.SteamId);
        
        Console.WriteLine($"[RoomService] å·²æ¸…é™¤ {player.SteamName} çš„æ‰€æœ‰ç¼“å­˜æ•°æ®");
        
        // å‘å¸ƒäº‹ä»¶
        ServerEventPublisher.PublishPlayerLeftRoom(room, player);
        
        // é€šçŸ¥å…¶ä»–ç©å®¶
        // ...
    }

    return await Task.FromResult(true);
}
```

---

## ğŸ¯ æ¨èçš„å®Œæ•´ä¿®å¤æ­¥éª¤

### ç¬¬1æ­¥ï¼šæ·»åŠ æ¸…ç†æ–¹æ³•ï¼ˆç«‹å³æ‰§è¡Œï¼‰

1. âœ… `EquipmentServerServiceImpl.ClearPlayerEquipment()`
2. âœ… `WeaponSyncServerServiceImpl.ClearPlayerWeapon()`

### ç¬¬2æ­¥ï¼šä¿®å¤ LeaveRoomAsyncï¼ˆç«‹å³æ‰§è¡Œï¼‰

åœ¨ `RoomServiceImpl.LeaveRoomAsync` ä¸­æ·»åŠ ï¼š
- âœ… è°ƒç”¨ `_healthSyncService?.ClearPlayerHealth()`
- âœ… è°ƒç”¨ `_equipmentService?.ClearPlayerEquipment()`
- âœ… è°ƒç”¨ `_weaponSyncService?.ClearPlayerWeapon()`

### ç¬¬3æ­¥ï¼šä¿®å¤ OnClientDisconnectedï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

ä½¿ç”¨**äº‹ä»¶é€šçŸ¥æ–¹å¼**ï¼ˆæ–¹æ¡ˆ3ï¼‰ï¼š
- âœ… å‘å¸ƒ `PlayerDisconnectedEvent` äº‹ä»¶
- âœ… å„æœåŠ¡è®¢é˜…äº‹ä»¶å¹¶æ¸…ç†è‡ªå·±çš„æ•°æ®
- âœ… é¿å… `PlayerManager` ä¾èµ–è¿‡å¤šæœåŠ¡

### ç¬¬4æ­¥ï¼šæ£€æŸ¥å®¢æˆ·ç«¯æ¸…ç†ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

æ£€æŸ¥ä»¥ä¸‹æ¨¡å—æ˜¯å¦è®¢é˜…äº† `NetworkDisconnectedEvent`ï¼š
- â“ `PlayerManager` - æ¸…ç†è¿œç¨‹ç©å®¶å¯¹è±¡
- â“ `SceneClientManager` - æ¸…ç†åœºæ™¯çŠ¶æ€
- â“ `AnimatorSyncManager` - æ¸…ç†åŠ¨ç”»åŒæ­¥
- â“ `ItemNetworkCoordinator` - æ¸…ç†ç‰©å“åŒæ­¥

### ç¬¬5æ­¥ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

åœ¨æ‰€æœ‰æ¸…ç†æ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—ï¼š
```csharp
Console.WriteLine($"[XXXService] æ¸…é™¤ç©å®¶ {steamId} çš„XXXæ•°æ®");
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯æ¸…å•

### æµ‹è¯•åœºæ™¯1ï¼šæ­£å¸¸ç¦»å¼€æˆ¿é—´
- [ ] ç©å®¶AåŠ å…¥æˆ¿é—´ï¼Œè£…å¤‡æ­¦å™¨ï¼Œç„¶åè°ƒç”¨ `LeaveRoomAsync`
- [ ] æ£€æŸ¥æœåŠ¡ç«¯æ—¥å¿—ï¼Œç¡®è®¤æ‰€æœ‰æ¸…ç†æ–¹æ³•è¢«è°ƒç”¨
- [ ] ç©å®¶Aé‡æ–°åŠ å…¥æˆ¿é—´
- [ ] éªŒè¯ç©å®¶Bçœ‹åˆ°çš„ç©å®¶AçŠ¶æ€æ˜¯å¦å¹²å‡€ï¼ˆæ— æ—§æ•°æ®ï¼‰

### æµ‹è¯•åœºæ™¯2ï¼šæ–­å¼€è¿æ¥
- [ ] ç©å®¶AåŠ å…¥æˆ¿é—´ï¼Œè£…å¤‡æ­¦å™¨ï¼Œç„¶åæ–­å¼€ç½‘ç»œ
- [ ] æ£€æŸ¥æœåŠ¡ç«¯æ—¥å¿—ï¼Œç¡®è®¤ `OnClientDisconnected` è¢«è°ƒç”¨
- [ ] æ£€æŸ¥æ‰€æœ‰æ¸…ç†æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨
- [ ] ç©å®¶Aé‡æ–°è¿æ¥å¹¶åŠ å…¥æˆ¿é—´
- [ ] éªŒè¯çŠ¶æ€æ˜¯å¦å¹²å‡€

### æµ‹è¯•åœºæ™¯3ï¼šé‡å¤åŠ å…¥æˆ¿é—´
- [ ] ç©å®¶AåŠ å…¥æˆ¿é—´1ï¼Œè£…å¤‡æ­¦å™¨
- [ ] ç©å®¶Aç¦»å¼€æˆ¿é—´1
- [ ] ç©å®¶Aç«‹å³åŠ å…¥æˆ¿é—´2
- [ ] éªŒè¯æˆ¿é—´2çš„å…¶ä»–ç©å®¶çœ‹ä¸åˆ°ç©å®¶Açš„æ—§æ•°æ®

---

## ğŸ“Š æ€»ç»“

### å‘ç°çš„é—®é¢˜ç»Ÿè®¡
- ğŸ”´ **é«˜å±é—®é¢˜**: 4ä¸ª
  - è£…å¤‡æ•°æ®æœªæ¸…ç†
  - æ­¦å™¨æ•°æ®æœªæ¸…ç†
  - æ–­å¼€è¿æ¥æ¸…ç†ä¸å½»åº•
  - ä½ç½®/è¡€é‡ç¼“å­˜åœ¨æ–­å¼€è¿æ¥æ—¶æœªæ¸…ç†
  
- ğŸŸ¡ **ä¸­å±é—®é¢˜**: 2ä¸ª
  - å¤–è§‚æ•°æ®æœªæ¸…ç†
  - ç¦»å¼€æˆ¿é—´æ—¶è¡€é‡ç¼“å­˜æœªæ¸…ç†

- ğŸŸ¢ **æ­£ç¡®å®ç°**: 3ä¸ª
  - æˆ¿é—´çŠ¶æ€æ¸…ç†
  - ä½ç½®ç¼“å­˜æ¸…ç†ï¼ˆåœ¨ç¦»å¼€æˆ¿é—´æ—¶ï¼‰
  - åœºæ™¯æ•°æ®æ¸…ç†ï¼ˆåœ¨ç¦»å¼€æˆ¿é—´æ—¶ï¼‰

### ä¿®å¤ä¼˜å…ˆçº§
1. **ç«‹å³ä¿®å¤**: æ·»åŠ è£…å¤‡å’Œæ­¦å™¨æ¸…ç†æ–¹æ³•ï¼Œä¿®å¤ `LeaveRoomAsync`
2. **é«˜ä¼˜å…ˆçº§**: ä½¿ç”¨äº‹ä»¶æ¨¡å¼ä¿®å¤ `OnClientDisconnected`
3. **ä¸­ä¼˜å…ˆçº§**: æ£€æŸ¥å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ¸…ç†
4. **ä½ä¼˜å…ˆçº§**: æ·»åŠ å®Œå–„çš„è°ƒè¯•æ—¥å¿—

---

**ç”Ÿæˆæ—¶é—´**: 2025-11-07  
**æ£€æŸ¥äººå‘˜**: DuckyNet AI Assistant  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0

