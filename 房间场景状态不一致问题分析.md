# DuckyNet æˆ¿é—´/åœºæ™¯çŠ¶æ€ä¸ä¸€è‡´æ·±åº¦åˆ†æ

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

åˆ†æä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
1. **ä»€ä¹ˆæƒ…å†µä¸‹ç©å®¶åŠ å…¥æˆ¿é—´ä¼šä»¥ä¸ºå·²ç»åœ¨æˆ¿é—´å†…äº†**
2. **ä»€ä¹ˆæƒ…å†µä¸‹ä»¥ä¸ºåœ¨åœºæ™¯å†…äº†å¯¼è‡´ä¸å‘è¿™ä¸ªæˆ¿é—´å¹¿æ’­æˆ¿é—´æ•°æ®**
3. **åŠ å…¥åœºæ™¯ä»€ä¹ˆæƒ…å†µä¸‹æœåŠ¡å™¨ä¼šæ”¶ä¸åˆ°**

---

## ğŸ” é—®é¢˜1ï¼šç©å®¶åŠ å…¥æˆ¿é—´æ—¶è¯¯è®¤ä¸ºå·²åœ¨æˆ¿é—´å†…

### é—®é¢˜æ ¹æº

#### 1.1 æœåŠ¡ç«¯æˆ¿é—´çŠ¶æ€åˆ¤æ–­é€»è¾‘

**æ–‡ä»¶ä½ç½®**: `Server/Managers/RoomManager.cs`

```csharp
// ç¬¬69-77è¡Œï¼šJoinRoom æ–¹æ³•çš„æ£€æŸ¥
if (_playerRoom.ContainsKey(player.SteamId))
{
    return new RoomOperationResult
    {
        Success = false,
        ErrorMessage = "ç©å®¶å·²åœ¨å…¶ä»–æˆ¿é—´"
    };
}
```

**æ½œåœ¨é—®é¢˜åœºæ™¯**:

##### åœºæ™¯ Aï¼šé‡å¤åŠ å…¥è¯·æ±‚ï¼ˆç½‘ç»œå»¶è¿Ÿï¼‰
- **è§¦å‘æ¡ä»¶**: å®¢æˆ·ç«¯åœ¨çŸ­æ—¶é—´å†…å¤šæ¬¡è°ƒç”¨ `JoinRoomAsync`ï¼ˆç½‘ç»œå¡é¡¿å¯¼è‡´é‡å‘ï¼‰
- **é—®é¢˜è¡¨ç°**: 
  - ç¬¬ä¸€æ¬¡è¯·æ±‚æˆåŠŸï¼Œç©å®¶è¢«æ·»åŠ åˆ° `_playerRoom` å­—å…¸
  - ç¬¬äºŒæ¬¡è¯·æ±‚åˆ°è¾¾æ—¶æ£€æµ‹åˆ°å·²åœ¨æˆ¿é—´ï¼Œè¿”å›é”™è¯¯
  - ä½†å®¢æˆ·ç«¯å¯èƒ½å·²ç»å¤„ç†äº†ç¬¬ä¸€æ¬¡æˆåŠŸçš„å“åº”ï¼ŒUI æ˜¾ç¤ºå·²åŠ å…¥
- **å½±å“èŒƒå›´**: å®¢æˆ·ç«¯çŠ¶æ€æ··ä¹±ï¼Œå¯èƒ½æ˜¾ç¤º"åŠ å…¥å¤±è´¥"ä½†å®é™…å·²åœ¨æˆ¿é—´ä¸­

##### åœºæ™¯ Bï¼šæ–­çº¿é‡è¿æœªæ¸…ç†
- **è§¦å‘æ¡ä»¶**: ç©å®¶æ–­çº¿å `OnClientDisconnected` æœªåŠæ—¶è°ƒç”¨ï¼Œæˆ–åœ¨è°ƒç”¨å‰å°±é‡è¿äº†
- **é—®é¢˜ä»£ç **: `Server/Managers/PlayerManager.cs` ç¬¬120-141è¡Œ
  ```csharp
  public void OnClientDisconnected(string ClientId)
  {
      lock (_lock)
      {
          if (_playersByClientId.TryGetValue(ClientId, out var player))
          {
              _playersByClientId.Remove(ClientId);
              _playersBySteamId.Remove(player.SteamId);
              _roomManager?.LeaveRoom(player);  // å…³é”®ï¼šè¿™é‡Œä¼šæ¸…ç†æˆ¿é—´çŠ¶æ€
          }
      }
  }
  ```
- **é£é™©**: å¦‚æœæ–­çº¿å¤„ç†å»¶è¿Ÿï¼Œæ–°è¿æ¥ç™»å½•æ—¶ä¼šå‘ç° `_playerRoom` ä¸­ä»æœ‰æ—§è®°å½•

##### åœºæ™¯ Cï¼šæˆ¿ä¸»ç‰¹æƒé€»è¾‘å†²çª
- **ä»£ç ä½ç½®**: `Server/Managers/RoomManager.cs` ç¬¬89-90è¡Œ
  ```csharp
  bool isReturningHost = room.HostSteamId == player.SteamId;
  ```
- **é—®é¢˜**: æˆ¿ä¸»ç¦»å¼€æˆ¿é—´å `HostSteamId` ä¸å˜ï¼ˆç¬¬173-176è¡Œï¼‰ï¼Œä½†å¦‚æœæˆ¿ä¸»æœªæ­£ç¡® `LeaveRoom` å°±é‡æ–°åŠ å…¥ï¼Œå¯èƒ½è§¦å‘"å·²åœ¨æˆ¿é—´"é”™è¯¯

---

#### 1.2 å®¢æˆ·ç«¯æˆ¿é—´çŠ¶æ€åˆ¤æ–­é€»è¾‘

**æ–‡ä»¶ä½ç½®**: `Client/Core/RoomManager.cs`

##### åœºæ™¯ Dï¼šå®¢æˆ·ç«¯çŠ¶æ€æœªåŒæ­¥
- **ä»£ç ä½ç½®**: ç¬¬23è¡Œ `public RoomInfo? CurrentRoom { get; private set; }`
- **é—®é¢˜åœºæ™¯**:
  1. å®¢æˆ·ç«¯è°ƒç”¨ `JoinRoomAsync` ä½†ç½‘ç»œä¸­æ–­
  2. å®¢æˆ·ç«¯æœ¬åœ° `CurrentRoom` ä»ä¸º `null`
  3. æœåŠ¡ç«¯å¯èƒ½å·²ç»å¤„ç†äº†è¯·æ±‚ï¼ˆå¦‚æœåœ¨ä¸­æ–­å‰åˆ°è¾¾ï¼‰
  4. å®¢æˆ·ç«¯é‡æ–°è¿æ¥åï¼ŒUI æ˜¾ç¤º"æœªåœ¨æˆ¿é—´"ï¼Œä½†æœåŠ¡ç«¯è®¤ä¸ºå·²åœ¨æˆ¿é—´

##### åœºæ™¯ Eï¼šäº‹ä»¶è®¢é˜…æ—¶åºé—®é¢˜
- **ä»£ç ä½ç½®**: ç¬¬123-161è¡Œ `OnRoomJoined` äº‹ä»¶å¤„ç†
- **é—®é¢˜**:
  ```csharp
  private async void OnRoomJoined(RoomJoinedEvent evt)
  {
      if (evt.Player.SteamId == GameContext.Instance.PlayerManager.LocalPlayer.Info.SteamId)
      {
          CurrentRoom = evt.Room;  // ç¬¬129è¡Œï¼šä»…åœ¨è‡ªå·±åŠ å…¥æ—¶è®¾ç½®
      }
  }
  ```
- **é£é™©**: å¦‚æœ `RoomJoinedEvent` æœªè§¦å‘æˆ–å»¶è¿Ÿï¼Œå®¢æˆ·ç«¯çš„ `CurrentRoom` ä¸ä¼šæ›´æ–°

---

### ğŸ› ï¸ è§£å†³æ–¹æ¡ˆå»ºè®®

#### æ–¹æ¡ˆ1ï¼šæ·»åŠ å¹‚ç­‰æ€§æ£€æŸ¥
åœ¨ `RoomServiceImpl.JoinRoomAsync` ä¸­ï¼š
```csharp
// æ£€æŸ¥ç©å®¶æ˜¯å¦å·²åœ¨ç›®æ ‡æˆ¿é—´ï¼ˆå…è®¸é‡å¤åŠ å…¥åŒä¸€æˆ¿é—´ï¼‰
if (_playerRoom.TryGetValue(player.SteamId, out var existingRoom))
{
    if (existingRoom.RoomId == request.RoomId)
    {
        // å¹‚ç­‰æ€§å¤„ç†ï¼šè¿”å›æˆåŠŸï¼ˆå·²ç»åœ¨æˆ¿é—´ä¸­ï¼‰
        return new RoomOperationResult { Success = true, Room = existingRoom };
    }
    else
    {
        return new RoomOperationResult { Success = false, ErrorMessage = "ç©å®¶å·²åœ¨å…¶ä»–æˆ¿é—´" };
    }
}
```

#### æ–¹æ¡ˆ2ï¼šå¼ºåˆ¶åŒæ­¥æˆ¿é—´çŠ¶æ€
å®¢æˆ·ç«¯åœ¨ `JoinRoomAsync` æˆåŠŸåï¼Œç«‹å³è°ƒç”¨ `GetCurrentRoomAsync` ç¡®è®¤çŠ¶æ€ã€‚

#### æ–¹æ¡ˆ3ï¼šæ·»åŠ å¿ƒè·³æ£€æµ‹
å®šæœŸéªŒè¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æˆ¿é—´çŠ¶æ€æ˜¯å¦ä¸€è‡´ã€‚

---

## ğŸ” é—®é¢˜2ï¼šè¯¯è®¤ä¸ºåœ¨åœºæ™¯å†…å¯¼è‡´ä¸å¹¿æ’­æ•°æ®

### é—®é¢˜æ ¹æº

#### 2.1 åœºæ™¯çŠ¶æ€åˆ¤æ–­é€»è¾‘

**å…³é”®æ•°æ®ç»“æ„**: `PlayerInfo.CurrentScenelData`ï¼ˆ`Shared/Services/IPlayerService.cs` ç¬¬123è¡Œï¼‰

##### åœºæ™¯ Fï¼šåœºæ™¯æ•°æ®æœªæ¸…ç†
- **é—®é¢˜ä»£ç **: `Server/Services/SceneServiceImpl.cs` ç¬¬150-151è¡Œ
  ```csharp
  // ç¦»å¼€åœºæ™¯æ—¶æ¸…é™¤åœºæ™¯æ•°æ®
  _playerManager.UpdatePlayerSceneDataByClientId(client.ClientId, new ScenelData("", ""));
  ```
- **é£é™©åœºæ™¯**:
  1. å®¢æˆ·ç«¯åˆ‡æ¢åœºæ™¯ä½† `LeaveSceneAsync` è°ƒç”¨å¤±è´¥ï¼ˆç½‘ç»œä¸­æ–­ï¼‰
  2. æœåŠ¡ç«¯ `CurrentScenelData` ä»ä¸ºæ—§åœºæ™¯
  3. æ–°åœºæ™¯çš„ `EnterSceneAsync` åˆ°è¾¾åï¼Œç©å®¶è¢«è®¤ä¸º"å·²åœ¨åœºæ™¯ä¸­"

##### åœºæ™¯ Gï¼šåœºæ™¯åŠ è½½æ—¶åºé—®é¢˜
- **å®¢æˆ·ç«¯ä»£ç **: `Client/Core/SceneClientManager.cs` ç¬¬43-57è¡Œ
  ```csharp
  private void OnSceneLoaded(SceneLoadedDetailEvent evt)
  {
      _scenelDataList = evt.ScenelData;  // ç¬¬46è¡Œï¼šç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€
      _sceneServiceClient.EnterSceneAsync(_scenelDataList);  // ç¬¬48è¡Œï¼šå¼‚æ­¥è°ƒç”¨
  }
  ```
- **é—®é¢˜**:
  - å®¢æˆ·ç«¯æœ¬åœ° `_scenelDataList` ç«‹å³æ›´æ–°
  - æœåŠ¡ç«¯æ›´æ–°å¯èƒ½å»¶è¿Ÿ
  - å¦‚æœå®¢æˆ·ç«¯åœ¨æœåŠ¡ç«¯æ›´æ–°å‰å‘é€ä½ç½®åŒæ­¥ï¼ŒæœåŠ¡ç«¯ä»è®¤ä¸ºç©å®¶åœ¨æ—§åœºæ™¯

##### åœºæ™¯ Hï¼šåœºæ™¯å¸è½½ä¸åŠ è½½çš„ç«æ€æ¡ä»¶
- **ä»£ç **: `Client/Core/SceneClientManager.cs` ç¬¬59-76è¡Œ
  ```csharp
  private void OnSceneUnloading(SceneUnloadingDetailEvent evt)
  {
      _sceneServiceClient.LeaveSceneAsync(evt.ScenelData);  // å¼‚æ­¥è°ƒç”¨
      
      // ç¬¬71-75è¡Œï¼šç«‹å³æ¸…ç©ºæœ¬åœ°çŠ¶æ€
      if (evt.ScenelData.SceneName == _scenelDataList.SceneName)
      {
          _scenelDataList = new ScenelData("", "");
      }
  }
  ```
- **é£é™©**: 
  - Unity åœºæ™¯åˆ‡æ¢æ—¶ï¼Œå¯èƒ½å…ˆè§¦å‘ `OnSceneLoaded`ï¼ˆæ–°åœºæ™¯ï¼‰ï¼Œå†è§¦å‘ `OnSceneUnloading`ï¼ˆæ—§åœºæ™¯ï¼‰
  - å¯¼è‡´æœåŠ¡ç«¯æ¥æ”¶é¡ºåºé”™ä¹±ï¼šå…ˆæ”¶åˆ° `EnterScene(æ–°åœºæ™¯)`ï¼Œå†æ”¶åˆ° `LeaveScene(æ—§åœºæ™¯)`
  - ç»“æœï¼šæœåŠ¡ç«¯è®¤ä¸ºç©å®¶ä¸åœ¨ä»»ä½•åœºæ™¯ï¼ˆè¢« `LeaveScene` æ¸…ç©ºäº†ï¼‰

---

#### 2.2 æ•°æ®åŒæ­¥å¹¿æ’­é€»è¾‘

**ä½ç½®åŒæ­¥è¿‡æ»¤æ¡ä»¶**: `Server/Services/PlayerUnitySyncServiceImpl.cs`ï¼ˆæœªæä¾›å®Œæ•´ä»£ç ï¼Œä½†å¯æ¨æ–­ï¼‰
**è¡€é‡åŒæ­¥è¿‡æ»¤æ¡ä»¶**: `Server/Services/HealthSyncServiceImpl.cs` ç¬¬113-123è¡Œ

```csharp
// æ¡ä»¶3: æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€ä¸ªåœºæ™¯ï¼ˆSceneNameï¼‰
if (targetPlayer.CurrentScenelData.SceneName != senderPlayer.CurrentScenelData.SceneName)
{
    continue;
}

// æ¡ä»¶4: æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€ä¸ªå­åœºæ™¯ï¼ˆSubSceneNameï¼‰
if (targetPlayer.CurrentScenelData.SubSceneName != senderPlayer.CurrentScenelData.SubSceneName)
{
    continue;
}
```

##### åœºæ™¯ Iï¼šç©ºåœºæ™¯å­—ç¬¦ä¸²å¯¼è‡´çš„"å…¨å±€å¹¿æ’­"
- **é—®é¢˜**: å¦‚æœ `SceneName` ä¸ºç©ºå­—ç¬¦ä¸² `""`ï¼Œå¯èƒ½å¯¼è‡´ä¸¤ç§ç»“æœï¼š
  - **æƒ…å†µ1**: æ‰€æœ‰ä¸åœ¨åœºæ™¯ä¸­çš„ç©å®¶äº’ç›¸èƒ½çœ‹åˆ°ï¼ˆæ„å¤–çš„"å…¨å±€æˆ¿é—´"æ•ˆæœï¼‰
  - **æƒ…å†µ2**: æ²¡æœ‰ä»»ä½•å¹¿æ’­ï¼ˆå› ä¸ºç©ºå­—ç¬¦ä¸²ä¸åŒ¹é…ä»»ä½•åœºæ™¯ï¼‰
- **é£é™©åœºæ™¯**:
  - ç©å®¶Aåœ¨åœºæ™¯ `"Forest"` ä¸­
  - ç©å®¶Bç¦»å¼€åœºæ™¯ï¼Œ`CurrentScenelData.SceneName = ""`
  - ç©å®¶Bå‘é€ä½ç½®åŒæ­¥ï¼ŒæœåŠ¡ç«¯æ£€æŸ¥ï¼š`"Forest" != ""`ï¼Œä¸å¹¿æ’­
  - ç»“æœï¼šç©å®¶Bçš„æ•°æ®ä¸ä¼šè¢«ä»»ä½•äººæ¥æ”¶

##### åœºæ™¯ Jï¼šæˆ¿é—´åŠ å…¥æ—¶åœºæ™¯çŠ¶æ€ä¸åŒæ­¥
- **é—®é¢˜ä»£ç **: `Server/Services/RoomServiceImpl.cs` ç¬¬135-136è¡Œ
  ```csharp
  Console.WriteLine($"[RoomService] ç©å®¶ {player.SteamName} åŠ å…¥æˆ¿é—´ï¼Œå½“å‰åœºæ™¯: '{player.CurrentScenelData.SceneName}' (å­åœºæ™¯: '{player.CurrentScenelData.SubSceneName}')");
  ```
- **é£é™©åœºæ™¯**:
  1. ç©å®¶Aåœ¨ä¸»èœå•ï¼ˆ`SceneName = ""`ï¼‰åˆ›å»ºæˆ¿é—´
  2. ç©å®¶Aè¿›å…¥åœºæ™¯ `"Forest"`ï¼ˆ`EnterSceneAsync` æˆåŠŸï¼‰
  3. ç©å®¶Båœ¨ä¸»èœå•åŠ å…¥æˆ¿é—´ï¼ˆ`SceneName = ""`ï¼‰
  4. æœåŠ¡ç«¯åœ¨ `JoinRoomAsync` ä¸­æ£€æŸ¥ `player.CurrentScenelData.SceneName`ï¼Œå‘ç°ä¸ºç©º
  5. å¹¿æ’­é€»è¾‘ï¼š
     ```csharp
     // ç¬¬164-186è¡Œï¼šå¦‚æœç°æœ‰ç©å®¶åœ¨åœºæ™¯ä¸­ï¼Œå‘é€åœºæ™¯è¿›å…¥äº‹ä»¶
     if (existingPlayer.CurrentScenelData != null && !string.IsNullOrEmpty(existingPlayer.CurrentScenelData.SceneName))
     {
         newPlayerContext.Call<ISceneClientService>().OnPlayerEnteredScene(existingPlayer, existingPlayer.CurrentScenelData);
     }
     ```
  6. **é—®é¢˜**: ç©å®¶Bä¼šæ”¶åˆ°"ç©å®¶Aåœ¨Foreståœºæ™¯"çš„é€šçŸ¥ï¼Œä½†å¦‚æœç©å®¶Bæ²¡æœ‰è¿›å…¥Forestï¼Œä½ç½®åŒæ­¥ä¼šè¢«è¿‡æ»¤

---

#### 2.3 GetRoomPlayersAsync çš„éšè—é—®é¢˜

**ä»£ç ä½ç½®**: `Server/Services/RoomServiceImpl.cs` ç¬¬345-428è¡Œ

##### åœºæ™¯ Kï¼šåˆ·æ–°ç©å®¶åˆ—è¡¨å¯¼è‡´é‡å¤é€šçŸ¥
- **é—®é¢˜ä»£ç **: ç¬¬364-421è¡Œ
  ```csharp
  public async Task<PlayerInfo[]> GetRoomPlayersAsync(IClientContext client, string roomId)
  {
      // ...
      
      // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¸»åŠ¨å‘è¯·æ±‚è€…å‘é€æˆ¿é—´å†…å…¶ä»–ç©å®¶çš„åŠ å…¥é€šçŸ¥
      foreach (var otherPlayer in players)
      {
          if (otherPlayer.SteamId == requester.SteamId) continue;
          
          // ğŸ”¥ ç®€åŒ–ï¼šåªå‘é€æˆ¿é—´æˆå‘˜é€šçŸ¥
          requesterContext.Call<IRoomClientService>().OnPlayerJoinedRoom(otherPlayer, room);
          
          // ğŸ”¥ ä¼˜åŒ–ï¼šå¦‚æœå¯¹æ–¹åœ¨åœºæ™¯ä¸­ï¼Œå‘é€ä½ç½®ï¼ˆä¸å‘é€åœºæ™¯é€šçŸ¥ï¼‰
          if (!string.IsNullOrEmpty(otherPlayer.CurrentScenelData.SceneName))
          {
              var lastPosition = _unitySyncService.GetLastPosition(otherPlayer.SteamId);
              if (lastPosition != null)
              {
                  requesterContext.Call<IPlayerClientService>().OnPlayerUnitySyncReceived(lastPosition);
              }
          }
      }
  }
  ```
- **é£é™©**:
  - å®¢æˆ·ç«¯å¤šæ¬¡è°ƒç”¨ `GetRoomPlayersAsync`ï¼ˆä¾‹å¦‚ `RefreshPlayerListAsync`ï¼‰
  - æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè§¦å‘ `OnPlayerJoinedRoom` äº‹ä»¶
  - å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å»é‡é€»è¾‘ï¼Œå¯èƒ½åˆ›å»ºé‡å¤çš„ `RemotePlayer` å¯¹è±¡

---

### ğŸ› ï¸ è§£å†³æ–¹æ¡ˆå»ºè®®

#### æ–¹æ¡ˆ1ï¼šæ·»åŠ åœºæ™¯çŠ¶æ€ç‰ˆæœ¬å·
åœ¨ `ScenelData` ä¸­æ·»åŠ  `Timestamp` å­—æ®µï¼š
```csharp
public class ScenelData
{
    public string SceneName { get; set; } = "";
    public string SubSceneName { get; set; } = "";
    public long Timestamp { get; set; }  // Unix æ—¶é—´æˆ³
}
```
æœåŠ¡ç«¯å¯ä»¥æ£€æµ‹å¹¶å¿½ç•¥è¿‡æœŸçš„åœºæ™¯åˆ‡æ¢è¯·æ±‚ã€‚

#### æ–¹æ¡ˆ2ï¼šå¼ºåˆ¶é¡ºåºæ‰§è¡Œåœºæ™¯åˆ‡æ¢
å®¢æˆ·ç«¯åœ¨ `OnSceneUnloading` ä¸­ä½¿ç”¨ `await`ï¼š
```csharp
private async void OnSceneUnloading(SceneUnloadingDetailEvent evt)
{
    await _sceneServiceClient.LeaveSceneAsync(evt.ScenelData);
    // ç­‰å¾…æœåŠ¡ç«¯ç¡®è®¤åå†æ›´æ–°æœ¬åœ°çŠ¶æ€
    if (evt.ScenelData.SceneName == _scenelDataList.SceneName)
    {
        _scenelDataList = new ScenelData("", "");
    }
}
```

#### æ–¹æ¡ˆ3ï¼šæœåŠ¡ç«¯åœºæ™¯åˆ‡æ¢åŸå­æ“ä½œ
æ·»åŠ ä¸€ä¸ªæ–°çš„ RPC æ–¹æ³• `SwitchSceneAsync`ï¼ŒåŒæ—¶å¤„ç†ç¦»å¼€å’Œè¿›å…¥ï¼š
```csharp
Task<bool> SwitchSceneAsync(IClientContext client, ScenelData fromScene, ScenelData toScene);
```

---

## ğŸ” é—®é¢˜3ï¼šæœåŠ¡å™¨æ”¶ä¸åˆ°åŠ å…¥åœºæ™¯è¯·æ±‚

### é—®é¢˜æ ¹æº

#### 3.1 RPC è°ƒç”¨å¤±è´¥åœºæ™¯

##### åœºæ™¯ Lï¼šå®¢æˆ·ç«¯æœªè¿æ¥åˆ°æœåŠ¡å™¨
- **ä»£ç ä½ç½®**: `Client/Core/SceneClientManager.cs` ç¬¬48è¡Œ
  ```csharp
  _sceneServiceClient.EnterSceneAsync(_scenelDataList);
  ```
- **é—®é¢˜**: å¦‚æœ `RpcClient` æœªè¿æ¥ï¼Œè°ƒç”¨ä¼šé™é»˜å¤±è´¥
- **æ£€æŸ¥ä½ç½®**: `Client/RPC/RpcClient.cs`ï¼ˆæœªæä¾›ä»£ç ï¼‰
- **å»ºè®®**: åœ¨è°ƒç”¨å‰æ£€æŸ¥è¿æ¥çŠ¶æ€ï¼š
  ```csharp
  if (GameContext.Instance.RpcClient.IsConnected)
  {
      _sceneServiceClient.EnterSceneAsync(_scenelDataList);
  }
  else
  {
      Debug.LogWarning("[SceneClientManager] RPC æœªè¿æ¥ï¼Œæ— æ³•å‘é€åœºæ™¯è¿›å…¥è¯·æ±‚");
  }
  ```

##### åœºæ™¯ Mï¼šç©å®¶æœªç™»å½•
- **æœåŠ¡ç«¯æ£€æŸ¥**: `Server/Services/SceneServiceImpl.cs` ç¬¬39-45è¡Œ
  ```csharp
  var player = _playerManager.GetPlayer(client.ClientId);
  if (player == null)
  {
      Console.WriteLine($"[SceneService] âš ï¸ æœªæ‰¾åˆ°ç©å®¶ä¿¡æ¯, ClientId={client.ClientId}");
      return Task.FromResult(false);
  }
  ```
- **é£é™©åœºæ™¯**:
  1. å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨ä½†æœªè°ƒç”¨ `LoginAsync`
  2. å®¢æˆ·ç«¯åŠ è½½åœºæ™¯å¹¶è°ƒç”¨ `EnterSceneAsync`
  3. æœåŠ¡ç«¯æ‰¾ä¸åˆ°ç©å®¶ä¿¡æ¯ï¼Œè¿”å› `false`
  4. å®¢æˆ·ç«¯æ²¡æœ‰å¤„ç†è¿”å›å€¼ï¼Œè®¤ä¸ºè¯·æ±‚æˆåŠŸ

##### åœºæ™¯ Nï¼šç©å®¶ä¸åœ¨æˆ¿é—´ä¸­
- **æœåŠ¡ç«¯ä»£ç **: `Server/Services/SceneServiceImpl.cs` ç¬¬72-76è¡Œï¼ˆ`SyncExistingPlayersToNewPlayer` æ–¹æ³•ï¼‰
  ```csharp
  var room = _roomManager.GetPlayerRoom(newPlayer);
  if (room == null)
  {
      Console.WriteLine($"[SceneService] âš ï¸ ç©å®¶ä¸åœ¨æˆ¿é—´ä¸­ï¼Œæ— æ³•åŒæ­¥å…¶ä»–ç©å®¶: {newPlayer.SteamName}");
      return;
  }
  ```
- **é—®é¢˜**: `EnterSceneAsync` æœ¬èº«ä¼šæˆåŠŸæ‰§è¡Œï¼ˆè¿”å› `true`ï¼‰ï¼Œä½†ä¸ä¼šåŒæ­¥å…¶ä»–ç©å®¶
- **é£é™©**: å®¢æˆ·ç«¯è®¤ä¸ºå·²è¿›å…¥åœºæ™¯ï¼Œä½†çœ‹ä¸åˆ°æˆ¿é—´å†…çš„å…¶ä»–ç©å®¶

---

#### 3.2 Unity åœºæ™¯ç³»ç»Ÿé—®é¢˜

##### åœºæ™¯ Oï¼šåœºæ™¯äº‹ä»¶æœªè§¦å‘
- **ä¾èµ–**: `Client/Patches/SceneEventBridge.cs`ï¼ˆæœªæä¾›ä»£ç ï¼‰
- **é—®é¢˜**: å¦‚æœ Harmony Patch å¤±è´¥æˆ– Unity åœºæ™¯åŠ è½½æ–¹å¼ç‰¹æ®Šï¼ˆå¦‚ `LoadSceneAsync`ï¼‰ï¼Œå¯èƒ½ä¸è§¦å‘äº‹ä»¶
- **æ£€æŸ¥æ–¹æ³•**: åœ¨ `SceneClientManager.OnSceneLoaded` ä¸­æ·»åŠ æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦è¢«è°ƒç”¨

##### åœºæ™¯ Pï¼šåœºæ™¯åŠ è½½æ—¶æœºè¿‡æ—©
- **ä»£ç ä½ç½®**: `Client/Core/SceneClientManager.cs` ç¬¬22-38è¡Œ
  ```csharp
  public SceneClientManager()
  {
      _eventSubscriber.EnsureInitializedAndSubscribe();
      _eventSubscriber.Subscribe<SceneLoadedDetailEvent>(OnSceneLoaded);
      // ...
  }
  ```
- **é£é™©**: å¦‚æœåœºæ™¯åœ¨ `SceneClientManager` åˆå§‹åŒ–å‰å°±å·²åŠ è½½å®Œæˆï¼Œäº‹ä»¶ä¸ä¼šè¢«æ•è·

---

#### 3.3 ç½‘ç»œå±‚é—®é¢˜

##### åœºæ™¯ Qï¼šRPC æ¶ˆæ¯ä¸¢å¤±
- **åŸå› **: TCP è¿æ¥è™½ç„¶ä¿è¯é¡ºåºï¼Œä½†å¦‚æœè¿æ¥ä¸­æ–­é‡è¿ï¼Œæœªå‘é€å®Œçš„æ¶ˆæ¯ä¼šä¸¢å¤±
- **å½±å“**: `EnterSceneAsync` è°ƒç”¨å¯èƒ½åœ¨å‘é€ç¼“å†²åŒºä¸­ï¼Œä½†è¿æ¥æ–­å¼€å¯¼è‡´æ¶ˆæ¯æœªåˆ°è¾¾æœåŠ¡å™¨

##### åœºæ™¯ Rï¼šæœåŠ¡ç«¯å¼‚å¸¸æœªæ•è·
- **ä»£ç ä½ç½®**: `Server/Services/SceneServiceImpl.cs` ç¬¬36-63è¡Œ
- **é—®é¢˜**: `EnterSceneAsync` æ–¹æ³•ä¸­æ²¡æœ‰ `try-catch`ï¼Œå¦‚æœä¸­é—´æ­¥éª¤æŠ›å‡ºå¼‚å¸¸ï¼š
  - å®¢æˆ·ç«¯ä¼šæ”¶åˆ° RPC è°ƒç”¨å¤±è´¥ï¼ˆæˆ–è¶…æ—¶ï¼‰
  - æœåŠ¡ç«¯å¯èƒ½å·²éƒ¨åˆ†æ‰§è¡Œï¼ˆå¦‚å·²æ›´æ–° `CurrentScenelData`ï¼‰

---

### ğŸ› ï¸ è§£å†³æ–¹æ¡ˆå»ºè®®

#### æ–¹æ¡ˆ1ï¼šæ·»åŠ è¯·æ±‚ç¡®è®¤æœºåˆ¶
ä¿®æ”¹ `ISceneService` æ¥å£ï¼Œè¿”å›è¯¦ç»†çš„ç»“æœï¼š
```csharp
public class SceneOperationResult
{
    public bool Success { get; set; }
    public string? ErrorMessage { get; set; }
    public ScenelData? CurrentScene { get; set; }
}

Task<SceneOperationResult> EnterSceneAsync(IClientContext client, ScenelData scenelData);
```

#### æ–¹æ¡ˆ2ï¼šå®¢æˆ·ç«¯é‡è¯•æœºåˆ¶
```csharp
private async void OnSceneLoaded(SceneLoadedDetailEvent evt)
{
    _scenelDataList = evt.ScenelData;
    
    int retryCount = 0;
    while (retryCount < 3)
    {
        try
        {
            var result = await _sceneServiceClient.EnterSceneAsync(_scenelDataList);
            if (result)
            {
                Debug.Log($"[SceneClientManager] åœºæ™¯è¿›å…¥æˆåŠŸ: {_scenelDataList.SceneName}");
                break;
            }
            else
            {
                Debug.LogWarning($"[SceneClientManager] åœºæ™¯è¿›å…¥å¤±è´¥ï¼Œé‡è¯• {retryCount + 1}/3");
                retryCount++;
                await Task.Delay(1000);
            }
        }
        catch (Exception ex)
        {
            Debug.LogError($"[SceneClientManager] åœºæ™¯è¿›å…¥å¼‚å¸¸: {ex.Message}");
            retryCount++;
            await Task.Delay(1000);
        }
    }
}
```

#### æ–¹æ¡ˆ3ï¼šæœåŠ¡ç«¯å¼‚å¸¸å¤„ç†
```csharp
public Task<bool> EnterSceneAsync(IClientContext client, ScenelData scenelData)
{
    try
    {
        var player = _playerManager.GetPlayer(client.ClientId);
        if (player == null)
        {
            Console.WriteLine($"[SceneService] âš ï¸ æœªæ‰¾åˆ°ç©å®¶ä¿¡æ¯, ClientId={client.ClientId}");
            return Task.FromResult(false);
        }

        // æ£€æŸ¥ç©å®¶æ˜¯å¦åœ¨æˆ¿é—´ä¸­
        var room = _roomManager.GetPlayerRoom(player);
        if (room == null)
        {
            Console.WriteLine($"[SceneService] âš ï¸ ç©å®¶ä¸åœ¨æˆ¿é—´ä¸­: {player.SteamName}");
            return Task.FromResult(false);  // æ˜ç¡®è¿”å›å¤±è´¥
        }

        // ... å…¶ä»–é€»è¾‘
        return Task.FromResult(true);
    }
    catch (Exception ex)
    {
        Console.WriteLine($"[SceneService] âŒ EnterSceneAsync å¼‚å¸¸: {ex.Message}");
        Console.WriteLine(ex.StackTrace);
        return Task.FromResult(false);
    }
}
```

---

## ğŸ“Š ç»¼åˆé—®é¢˜çŸ©é˜µ

| é—®é¢˜åœºæ™¯ | è§¦å‘æ¡ä»¶ | å®¢æˆ·ç«¯è¡¨ç° | æœåŠ¡ç«¯è¡¨ç° | å½±å“èŒƒå›´ | ä¸¥é‡ç¨‹åº¦ |
|---------|---------|-----------|-----------|---------|---------|
| **A: é‡å¤åŠ å…¥è¯·æ±‚** | ç½‘ç»œå»¶è¿Ÿå¯¼è‡´é‡å‘ | UI æ˜¾ç¤ºé”™è¯¯ä½†å®é™…å·²åŠ å…¥ | è¿”å›"å·²åœ¨æˆ¿é—´"é”™è¯¯ | å•ä¸ªç©å®¶ | ä½ |
| **B: æ–­çº¿é‡è¿æœªæ¸…ç†** | æ–­çº¿å¤„ç†å»¶è¿Ÿ | æ— æ³•åŠ å…¥æˆ¿é—´ | æ£€æµ‹åˆ°ç©å®¶ä»åœ¨æˆ¿é—´ | å•ä¸ªç©å®¶ | ä¸­ |
| **C: æˆ¿ä¸»ç‰¹æƒå†²çª** | æˆ¿ä¸»æœªæ­£ç¡®ç¦»å¼€å°±é‡è¿ | åŠ å…¥å¤±è´¥ | æˆ¿ä¸»æ£€æµ‹é€»è¾‘å†²çª | æˆ¿ä¸»ç©å®¶ | ä¸­ |
| **D: å®¢æˆ·ç«¯çŠ¶æ€æœªåŒæ­¥** | ç½‘ç»œä¸­æ–­ | æ˜¾ç¤ºæœªåœ¨æˆ¿é—´ä½†æœåŠ¡ç«¯å·²åŠ å…¥ | è®¤ä¸ºç©å®¶å·²åœ¨æˆ¿é—´ | å•ä¸ªç©å®¶ | é«˜ |
| **E: äº‹ä»¶è®¢é˜…æ—¶åºé—®é¢˜** | äº‹ä»¶æœªè§¦å‘ | `CurrentRoom` æœªæ›´æ–° | æ­£å¸¸ | å•ä¸ªç©å®¶ | ä¸­ |
| **F: åœºæ™¯æ•°æ®æœªæ¸…ç†** | `LeaveSceneAsync` å¤±è´¥ | å®¢æˆ·ç«¯å·²ç¦»å¼€åœºæ™¯ | æœåŠ¡ç«¯è®¤ä¸ºä»åœ¨åœºæ™¯ä¸­ | å•ä¸ªç©å®¶ | é«˜ |
| **G: åœºæ™¯åŠ è½½æ—¶åº** | å®¢æˆ·ç«¯å…ˆæ›´æ–°æœ¬åœ°çŠ¶æ€ | æœ¬åœ°åœºæ™¯å·²åˆ‡æ¢ | æœåŠ¡ç«¯åœºæ™¯æ•°æ®æ»å | å•ä¸ªç©å®¶ | ä¸­ |
| **H: åœºæ™¯åˆ‡æ¢ç«æ€** | Unity åœºæ™¯äº‹ä»¶é¡ºåºé”™ä¹± | æ­£å¸¸ | ç©å®¶åœºæ™¯çŠ¶æ€è¢«é”™è¯¯æ¸…ç©º | å•ä¸ªç©å®¶ | é«˜ |
| **I: ç©ºåœºæ™¯å­—ç¬¦ä¸²** | ç¦»å¼€åœºæ™¯æ—¶åœºæ™¯åä¸ºç©º | æ­£å¸¸ | ä¸å¹¿æ’­ä»»ä½•æ•°æ® | å½±å“æ‰€æœ‰ç©å®¶ | é«˜ |
| **J: æˆ¿é—´åŠ å…¥åœºæ™¯ä¸åŒæ­¥** | ç©å®¶åœ¨ä¸åŒåœºæ™¯åŠ å…¥æˆ¿é—´ | æ”¶åˆ°å…¶ä»–ç©å®¶åœºæ™¯é€šçŸ¥ä½†ä¸åœ¨åŒä¸€åœºæ™¯ | æ­£å¸¸ | å¤šä¸ªç©å®¶ | ä¸­ |
| **K: é‡å¤åˆ·æ–°ç©å®¶åˆ—è¡¨** | å¤šæ¬¡è°ƒç”¨ `GetRoomPlayersAsync` | åˆ›å»ºé‡å¤çš„ RemotePlayer | é‡å¤å‘é€é€šçŸ¥ | å•ä¸ªç©å®¶ | ä¸­ |
| **L: å®¢æˆ·ç«¯æœªè¿æ¥** | RPC æœªè¿æ¥ | åœºæ™¯åˆ‡æ¢æ­£å¸¸ä½†æœåŠ¡ç«¯ä¸çŸ¥é“ | æ”¶ä¸åˆ°è¯·æ±‚ | å•ä¸ªç©å®¶ | é«˜ |
| **M: ç©å®¶æœªç™»å½•** | ç™»å½•å‰åŠ è½½åœºæ™¯ | åœºæ™¯åŠ è½½æˆåŠŸ | æ‹’ç» EnterScene è¯·æ±‚ | å•ä¸ªç©å®¶ | ä¸­ |
| **N: ç©å®¶ä¸åœ¨æˆ¿é—´** | åŠ å…¥åœºæ™¯å‰æœªåŠ å…¥æˆ¿é—´ | åœºæ™¯åŠ è½½æˆåŠŸä½†çœ‹ä¸åˆ°å…¶ä»–ç©å®¶ | æ‹’ç»åŒæ­¥å…¶ä»–ç©å®¶ | å•ä¸ªç©å®¶ | ä¸­ |
| **O: åœºæ™¯äº‹ä»¶æœªè§¦å‘** | Harmony Patch å¤±è´¥ | åœºæ™¯åŠ è½½ä½†ä¸å‘é€è¯·æ±‚ | æ”¶ä¸åˆ°è¯·æ±‚ | å•ä¸ªç©å®¶ | é«˜ |
| **P: åœºæ™¯åŠ è½½æ—¶æœºè¿‡æ—©** | åœºæ™¯åœ¨äº‹ä»¶è®¢é˜…å‰åŠ è½½ | åœºæ™¯åŠ è½½ä½†ä¸å‘é€è¯·æ±‚ | æ”¶ä¸åˆ°è¯·æ±‚ | å•ä¸ªç©å®¶ | ä¸­ |
| **Q: RPC æ¶ˆæ¯ä¸¢å¤±** | ç½‘ç»œä¸­æ–­ | åœºæ™¯åˆ‡æ¢æ­£å¸¸ | æ”¶ä¸åˆ°è¯·æ±‚ | å•ä¸ªç©å®¶ | ä¸­ |
| **R: æœåŠ¡ç«¯å¼‚å¸¸** | ä»£ç é”™è¯¯ | RPC è°ƒç”¨å¤±è´¥æˆ–è¶…æ—¶ | çŠ¶æ€å¯èƒ½éƒ¨åˆ†æ›´æ–° | å•ä¸ªç©å®¶ | é«˜ |

---

## ğŸš¨ é«˜ä¼˜å…ˆçº§ä¿®å¤å»ºè®®

### 1. æ·»åŠ çŠ¶æ€åŒæ­¥ç¡®è®¤æœºåˆ¶ï¼ˆè§£å†³é—®é¢˜Dã€Fã€Lï¼‰
- æ‰€æœ‰å…³é”® RPC è°ƒç”¨ï¼ˆJoinRoomã€EnterSceneï¼‰è¿”å›è¯¦ç»†ç»“æœ
- å®¢æˆ·ç«¯å¿…é¡»ç­‰å¾…æœåŠ¡ç«¯ç¡®è®¤åå†æ›´æ–°æœ¬åœ°çŠ¶æ€

### 2. åœºæ™¯åˆ‡æ¢åŸå­æ“ä½œï¼ˆè§£å†³é—®é¢˜Hï¼‰
- åˆå¹¶ `LeaveScene` å’Œ `EnterScene` ä¸ºå•ä¸€åŸå­æ“ä½œ
- æˆ–è€…ä½¿ç”¨ç‰ˆæœ¬å·/æ—¶é—´æˆ³ç¡®ä¿é¡ºåºæ‰§è¡Œ

### 3. ç©ºåœºæ™¯å¤„ç†ï¼ˆè§£å†³é—®é¢˜Iï¼‰
- åœ¨å¹¿æ’­é€»è¾‘ä¸­æ˜ç¡®å¤„ç†ç©ºåœºæ™¯ï¼ˆä¸åœ¨ä»»ä½•åœºæ™¯ï¼‰çš„æƒ…å†µ
- æˆ–è€…å®šä¹‰"å¤§å…åœºæ™¯"ä½œä¸ºé»˜è®¤åœºæ™¯ï¼Œé¿å…ç©ºå­—ç¬¦ä¸²

### 4. æ–­çº¿é‡è¿æ¸…ç†ï¼ˆè§£å†³é—®é¢˜Bï¼‰
- åœ¨ `OnClientConnected` æ—¶æ£€æŸ¥æ˜¯å¦æœ‰åŒ SteamId çš„æ—§è¿æ¥
- å¼ºåˆ¶æ¸…ç†æ—§è¿æ¥çš„æ‰€æœ‰çŠ¶æ€ï¼ˆæˆ¿é—´ã€åœºæ™¯ã€ç¼“å­˜æ•°æ®ï¼‰

### 5. å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—ï¼ˆè§£å†³é—®é¢˜Rï¼‰
- æ‰€æœ‰ RPC æ–¹æ³•æ·»åŠ  try-catch
- è®°å½•è¯¦ç»†çš„çŠ¶æ€è½¬æ¢æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

---

## ğŸ“ è°ƒè¯•æ£€æŸ¥æ¸…å•

å½“é‡åˆ°çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜æ—¶ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

### å®¢æˆ·ç«¯æ£€æŸ¥
1. âœ… `GameContext.Instance.RpcClient.IsConnected` - RPC æ˜¯å¦è¿æ¥
2. âœ… `GameContext.Instance.PlayerManager.LocalPlayer.Info` - ç©å®¶æ˜¯å¦ç™»å½•
3. âœ… `GameContext.Instance.RoomManager.CurrentRoom` - å®¢æˆ·ç«¯è®¤ä¸ºæ˜¯å¦åœ¨æˆ¿é—´ä¸­
4. âœ… `GameContext.Instance.SceneClientManager._scenelDataList` - å®¢æˆ·ç«¯å½“å‰åœºæ™¯
5. âœ… `GameContext.Instance.RoomManager.RoomPlayers` - å®¢æˆ·ç«¯æˆ¿é—´ç©å®¶åˆ—è¡¨
6. âœ… æ—¥å¿—ä¸­æœç´¢ `[SceneClientManager]` å’Œ `[RoomManager]` - ç¡®è®¤äº‹ä»¶è§¦å‘

### æœåŠ¡ç«¯æ£€æŸ¥
1. âœ… `_playersByClientId` - ç©å®¶æ˜¯å¦å·²ç™»å½•
2. âœ… `_playerRoom` - æœåŠ¡ç«¯è®¤ä¸ºç©å®¶åœ¨å“ªä¸ªæˆ¿é—´
3. âœ… `player.CurrentScenelData` - æœåŠ¡ç«¯è®°å½•çš„ç©å®¶åœºæ™¯
4. âœ… `_roomPlayers[roomId]` - æœåŠ¡ç«¯æˆ¿é—´ç©å®¶åˆ—è¡¨
5. âœ… æ—¥å¿—ä¸­æœç´¢ç©å®¶ SteamId - è¿½è¸ªçŠ¶æ€å˜åŒ–
6. âœ… æ—¥å¿—ä¸­æœç´¢ `OnPlayerJoinedRoom` å’Œ `OnPlayerEnteredScene` - ç¡®è®¤å¹¿æ’­æ‰§è¡Œ

### ç½‘ç»œå±‚æ£€æŸ¥
1. âœ… Wireshark æŠ“åŒ… - ç¡®è®¤æ¶ˆæ¯æ˜¯å¦çœŸå®å‘é€
2. âœ… RPC è°ƒç”¨è¿”å›å€¼ - æ˜¯å¦æœ‰å¼‚å¸¸æˆ–è¶…æ—¶
3. âœ… æœåŠ¡ç«¯ `Update()` çº¿ç¨‹ - æ˜¯å¦æ­£å¸¸è¿è¡Œ
4. âœ… å®¢æˆ·ç«¯ `Update()` çº¿ç¨‹ - æ˜¯å¦æ­£å¸¸è¿è¡Œ

---

## ğŸ“ˆ æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **çŠ¶æ€æœºæ¨¡å¼**: å°†æˆ¿é—´å’Œåœºæ™¯çŠ¶æ€ç®¡ç†æ”¹ä¸ºæ˜¾å¼çŠ¶æ€æœºï¼Œå®šä¹‰æ‰€æœ‰åˆæ³•çš„çŠ¶æ€è½¬æ¢
2. **å‘½ä»¤æ¨¡å¼**: æ‰€æœ‰çŠ¶æ€å˜æ›´æ“ä½œæ”¹ä¸ºå¯å›æ»šçš„å‘½ä»¤ï¼Œæ”¯æŒæ’¤é”€å’Œé‡è¯•
3. **äº‹ä»¶æº¯æº**: è®°å½•æ‰€æœ‰çŠ¶æ€å˜æ›´äº‹ä»¶ï¼Œä¾¿äºå›æº¯å’Œè°ƒè¯•
4. **åˆ†å¸ƒå¼ä¸€è‡´æ€§**: å¦‚æœæœªæ¥æ”¯æŒå¤šæœåŠ¡å™¨ï¼Œè€ƒè™‘ä½¿ç”¨ Raft æˆ– Paxos ä¿è¯ä¸€è‡´æ€§

---

**ç”Ÿæˆæ—¶é—´**: 2025-11-07  
**åˆ†æäººå‘˜**: DuckyNet AI Assistant  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0

