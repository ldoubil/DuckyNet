# 动画调试系统使用说明

## 📋 概述

动画调试系统为 DuckyNet 提供了完整的角色动画测试和调试功能，基于游戏源码中的 `CharacterAnimationControl.cs` 实现。

## 🏗️ 架构组成

### 1. **AnimationDebugger** (`Client/Core/AnimationDebugger.cs`)
核心动画调试类，提供底层动画控制能力。

**主要功能：**
- ✅ 获取和显示动画参数状态
- ✅ 设置动画参数（Float, Int, Bool, Trigger）
- ✅ 控制动画层权重
- ✅ 查询动画状态信息

**关键方法：**
```csharp
// 获取动画信息
AnimationParameterInfo GetAnimationInfo(GameObject character)

// 设置参数
bool SetAnimatorFloat(GameObject character, string paramName, float value)
bool SetAnimatorInt(GameObject character, string paramName, int value)
bool SetAnimatorBool(GameObject character, string paramName, bool value)

// 触发动画
bool TriggerAnimation(GameObject character, string triggerName)

// 层权重控制
bool SetLayerWeight(GameObject character, string layerName, float weight)

// 打印调试信息
void LogAnimationInfo(GameObject character)
```

### 2. **UnitManager 动画扩展** (`Client/Core/UnitManager.cs`)
为单位管理器添加动画调试方法。

**新增方法：**
```csharp
// 信息查询
AnimationParameterInfo? GetAnimationInfo(GameObject unit)
void LogUnitAnimationInfo(GameObject unit)
void LogAllUnitsAnimationInfo()

// 移动动画
bool SetUnitMovementAnimation(GameObject unit, float speed, Vector2 direction)
void TestUnitWalkForward(GameObject unit, float speed = 1.0f)
void TestUnitWalkBackward(GameObject unit, float speed = 1.0f)
void TestUnitWalkLeft(GameObject unit, float speed = 1.0f)
void TestUnitWalkRight(GameObject unit, float speed = 1.0f)
void StopUnitMovement(GameObject unit)

// 攻击和状态
bool TriggerUnitAttack(GameObject unit)
bool SetUnitDashing(GameObject unit, bool dashing)
bool SetUnitHandState(GameObject unit, int handState)
bool SetUnitWeaponOut(GameObject unit, bool weaponOut)

// 层控制
bool SetUnitLayerWeight(GameObject unit, string layerName, float weight)

// 批量测试
void TestAllUnitsAttack()
void TestAllUnitsMovement(float speed, Vector2 direction)
```

### 3. **AnimationDebugWindow** (`Client/UI/AnimationDebugWindow.cs`)
图形化动画调试界面。

**功能模块：**

#### 单位选择
- 从 UnitManager 管理的单位中选择目标
- 显示所有可用单位列表

#### 动画信息查看
- 查看当前单位的动画状态
- 查看所有单位的动画信息
- 实时显示动画参数值

#### 移动动画控制
- 调整移动速度（0-2）
- 设置移动方向（X: -1到1，Y: -1到1）
- 快捷方向按钮：前/后/左/右
- 停止移动

#### 攻击与状态
- 触发单个/全体攻击动画
- 切换武器拿出状态
- 调整手部状态（0-5）
- 切换冲刺状态

#### 动画层权重
- 自定义层名称（默认：MeleeAttack）
- 调整层权重（0-1）
- 实时应用到角色

#### 批量测试
- 全体单位向前移动
- 全体单位停止

#### 自动测试循环
- 自动循环播放：站立 → 前进 → 攻击 → 后退
- 每个动作持续 2 秒
- 用于长时间测试动画流畅性

## 🎮 使用方法

### 打开动画调试窗口
按 **F5** 键打开/关闭动画调试窗口

### 基本工作流程

#### 1. 创建测试单位
首先使用 **F8** 调试窗口创建测试单位：
- 单位管理 → 创建单位
- 选择队伍、属性、位置

#### 2. 选择要测试的单位
在动画调试窗口（F5）中：
- 从单位列表中选择目标单位
- 显示当前选中的单位名称

#### 3. 查看动画信息
```
点击"查看当前单位动画" → 控制台显示详细动画参数
点击"查看所有单位动画" → 显示所有单位信息
```

**输出示例：**
```
=== 角色动画信息: TestUnit ===
当前状态: State_12345 (时间: 0.45)

浮点参数:
  MoveSpeed = 1.50
  MoveDirX = 0.00
  MoveDirY = 1.00

整数参数:
  HandState = 2

布尔参数:
  RightHandOut = True
  Dashing = False

动画层:
  [0] Base Layer - 权重: 1.00
  [1] MeleeAttack - 权重: 0.35
```

#### 4. 测试移动动画
```
方式1: 使用快捷按钮
    向前/向后/向左/向右 → 快速测试基本移动

方式2: 自定义参数
    调整移动速度滑块 → 设置方向 X/Y → 点击"应用移动"
    
停止移动:
    点击"停止移动"或将速度设为0
```

#### 5. 测试攻击动画
```
单体攻击: 点击"触发攻击"
全体攻击: 点击"全体攻击"（所有管理单位同时攻击）
```

#### 6. 测试状态切换
```
武器状态: 勾选/取消"拿出武器"
手部状态: 拖动滑块（0-5）
冲刺状态: 勾选/取消"冲刺中"
```

#### 7. 高级：动画层权重
```
1. 输入层名称（如：MeleeAttack）
2. 调整权重滑块（0-1）
3. 点击"应用层权重"
```

#### 8. 自动测试模式
```
勾选"自动测试动画循环" → 单位自动执行循环动作
用于长时间观察动画表现
```

## 📊 游戏动画系统分析

### CharacterAnimationControl 核心参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| `MoveSpeed` | Float | 移动速度（0=静止，1=走，2=跑） |
| `MoveDirX` | Float | 横向移动方向（-1=左，1=右） |
| `MoveDirY` | Float | 纵向移动方向（-1=后，1=前） |
| `RightHandOut` | Bool | 右手是否拿出武器 |
| `HandState` | Int | 手部动画状态（0-5）<br>取决于 `HandheldAnimationType` |
| `Dashing` | Bool | 是否在冲刺 |
| `Attack` | Trigger | 攻击触发器 |

### 动画层结构

1. **Base Layer** (权重 1.0)
   - 基础移动动画
   - 站立/行走/跑步

2. **MeleeAttack Layer** (权重动态)
   - 近战攻击动画
   - 使用 `attackLayerWeightCurve` 平滑过渡
   - 攻击时权重从 0 → 1 → 0

### HandheldAnimationType 枚举
```csharp
// 游戏中的手部动画类型
enum HandheldAnimationType
{
    none = 0,           // 无武器
    meleeWeapon = 1,    // 近战武器
    pistol = 2,         // 手枪
    rifle = 3,          // 步枪
    // ... 其他类型
}
```

## 💡 使用技巧

### 1. 快速测试移动流畅性
```
开启"自动测试动画循环" → 观察角色在不同动作间的过渡
```

### 2. 调试近战攻击动画
```
1. 设置 HandState = 1 (近战武器)
2. 勾选"拿出武器"
3. 点击"触发攻击"
4. 调整 MeleeAttack 层权重观察混合效果
```

### 3. 测试远程射击动画
```
1. 设置 HandState = 2 (手枪) 或 3 (步枪)
2. 勾选"拿出武器"
3. 测试不同移动方向的射击动画
```

### 4. 批量动画压力测试
```
1. 创建 10+ 个测试单位
2. 点击"全体攻击"
3. 观察同时播放动画的性能
```

### 5. 动画混合调试
```
1. 设置移动速度 > 0（播放移动动画）
2. 同时触发攻击
3. 观察两个动画层的混合效果
```

## 🔧 开发者扩展

### 添加新的动画参数
```csharp
// 在 AnimationDebugger 的 InitializeHashes() 中添加
_animatorHashes["NewParam"] = Animator.StringToHash("NewParam");

// 在 AnimationDebugWindow 中添加控制UI
if (GUILayout.Button("测试新参数"))
{
    _animationDebugger.SetAnimatorFloat(unit, "NewParam", value);
}
```

### 添加自定义测试脚本
```csharp
// 在 UnitManager 中添加
public void TestCustomAnimation(GameObject unit)
{
    // 设置复杂的动画参数组合
    SetUnitMovementAnimation(unit, 1.5f, new Vector2(0, 1));
    SetUnitWeaponOut(unit, true);
    SetUnitHandState(unit, 2);
    // 延迟触发攻击...
}
```

## 🐛 故障排除

### 动画不播放
1. 检查单位是否有 `CharacterAnimationControl` 组件
2. 使用"查看动画信息"确认 Animator 已初始化
3. 检查动画参数名是否正确

### 动画卡顿
1. 检查是否有多个系统同时控制动画
2. 关闭"自动测试"避免冲突
3. 使用"停止移动"重置状态

### 层权重不生效
1. 确认层名称拼写正确（区分大小写）
2. 检查该层是否存在：`查看动画信息 → 动画层列表`
3. 某些层可能需要特定条件才能激活

## 📝 快捷键总结

| 按键 | 功能 |
|------|------|
| F5 | 打开/关闭动画调试窗口 |
| F8 | 打开/关闭调试窗口（创建单位） |
| F10 | 主菜单 |
| F9 | 聊天窗口 |
| F6 | 玩家列表 |

## 🎯 应用场景

### 游戏开发
- ✅ 测试新的角色动画
- ✅ 调试动画状态机转换
- ✅ 验证动画混合效果
- ✅ 性能压力测试

### Mod 开发
- ✅ 理解游戏动画系统
- ✅ 实现自定义角色行为
- ✅ 开发 AI 动画逻辑
- ✅ 创建动画触发器

### 教学演示
- ✅ 展示动画系统工作原理
- ✅ 实时演示参数影响
- ✅ 可视化动画层混合

## 📚 相关文档

- `CharacterAnimationControl.cs` - 游戏源码动画控制类
- `调试模块开发指南.md` - 调试系统架构说明
- `项目结构说明.md` - 项目整体架构

## 🔄 更新日志

### v1.0 (2025-10-29)
- ✅ 基于 `CharacterAnimationControl.cs` 实现核心功能
- ✅ 完整的动画参数控制
- ✅ 图形化调试界面
- ✅ 批量测试功能
- ✅ 自动循环测试模式
- ✅ 动画层权重控制

---

**开发建议：** 结合 F8 调试窗口和 F5 动画调试窗口使用，可以实现完整的角色测试工作流！

