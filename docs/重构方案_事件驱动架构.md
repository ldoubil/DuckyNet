# DuckyNet é‡æ„æ–¹æ¡ˆï¼šäº‹ä»¶é©±åŠ¨æ¶æ„

## ğŸ“‹ ç°çŠ¶åˆ†æ

### ğŸ”´ ä¸»è¦é—®é¢˜

#### 1. **é‡å¤çš„é€šçŸ¥é€»è¾‘**
- **æœåŠ¡å™¨ç«¯**ï¼šæ¯ä¸ªæœåŠ¡éƒ½åœ¨æ‰‹åŠ¨éå†æˆ¿é—´ç©å®¶å¹¶è°ƒç”¨ RPC
  - `SceneServiceImpl.NotifyPlayerEnteredScene()` 
  - `CharacterServiceImpl.NotifyAppearanceUpdate()`
  - `RoomServiceImpl` ä¸­çš„æ‰‹åŠ¨éå†é€šçŸ¥
- **å®¢æˆ·ç«¯**ï¼šç”Ÿå‘½å‘¨æœŸç®¡ç†åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹ï¼ˆModBehaviour, RoomPage, LobbyPageï¼‰

#### 2. **æœåŠ¡é—´å¼ºè€¦åˆ**
- `CharacterServiceImpl` ä½¿ç”¨**åå°„**è®¿é—® `SceneServiceImpl` çš„ç§æœ‰å­—æ®µ
- æœåŠ¡ä¹‹é—´éœ€è¦äº’ç›¸æ³¨å…¥å¼•ç”¨
- éš¾ä»¥å•ç‹¬æµ‹è¯•å’Œæ›¿æ¢

#### 3. **ç¼ºå°‘ç»Ÿä¸€äº‹ä»¶ç³»ç»Ÿ**
- äº‹ä»¶éƒ½æ˜¯ç‚¹å¯¹ç‚¹çš„ï¼ˆ`event Action`ï¼‰
- æ²¡æœ‰å…¨å±€äº‹ä»¶æ€»çº¿
- æœåŠ¡é—´éœ€è¦ç›´æ¥è°ƒç”¨æ‰èƒ½é€šçŸ¥

#### 4. **é‡å¤çš„ä¸šåŠ¡é€»è¾‘éªŒè¯**
```csharp
// åœ¨æ¯ä¸€ä¸ªæœåŠ¡æ–¹æ³•ä¸­é‡å¤è¿™æ®µä»£ç ï¼š
if (!_playerManager.IsLoggedIn(client.ClientId)) { return false; }
var player = _playerManager.GetPlayer(client.ClientId);
if (player == null) { return false; }
var room = _roomManager.GetPlayerRoom(player.SteamId);
if (room == null) { return false; }
```

#### 5. **å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†æ··ä¹±**
- åŒæ­¥å¯åŠ¨/åœæ­¢é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹
- åœºæ™¯åˆå§‹åŒ–é€»è¾‘é‡å¤
- æˆ¿é—´åŠ å…¥/ç¦»å¼€çš„å¤„ç†åˆ†æ•£

---

## ğŸ¯ é‡æ„ç›®æ ‡

1. **ç»Ÿä¸€äº‹ä»¶ç³»ç»Ÿ**ï¼šåˆ›å»ºäº‹ä»¶æ€»çº¿ï¼Œè§£è€¦æœåŠ¡é€šä¿¡
2. **å‡å°‘é‡å¤ä»£ç **ï¼šæå–é€šç”¨é€»è¾‘åˆ°åŸºç±»æˆ–ä¸­é—´ä»¶
3. **ç®€åŒ–ä¾èµ–**ï¼šæœåŠ¡é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¾èµ–
4. **æ¨¡å—åŒ–**ï¼šæ¯ä¸ªæ¨¡å—ç‹¬ç«‹ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. äº‹ä»¶æ€»çº¿ç³»ç»Ÿ (Event Bus)

#### Shared - EventBus
```csharp
// Shared/Events/EventBus.cs
public static class EventBus
{
    private static readonly Dictionary<Type, List<object>> _handlers = new();
    
    public static void Subscribe<T>(Action<T> handler) where T : IGameEvent;
    public static void Unsubscribe<T>(Action<T> handler) where T : IGameEvent;
    public static void Publish<T>(T eventData) where T : IGameEvent;
    public static void Clear();
}

// Shared/Events/IGameEvent.cs
public interface IGameEvent { }

// äº‹ä»¶å®šä¹‰ç¤ºä¾‹
public record PlayerJoinedRoomEvent(PlayerInfo Player, RoomInfo Room) : IGameEvent;
public record PlayerLeftRoomEvent(PlayerInfo Player, RoomInfo Room) : IGameEvent;
public record PlayerEnteredSceneEvent(PlayerSceneInfo PlayerSceneInfo) : IGameEvent;
public record PlayerAppearanceUpdatedEvent(string SteamId, byte[] AppearanceData) : IGameEvent;
public record CharacterCreatedEvent(PlayerInfo Player) : IGameEvent;
```

#### ä¼˜åŠ¿
- âœ… æœåŠ¡é—´è§£è€¦ï¼Œé€šè¿‡äº‹ä»¶é€šä¿¡
- âœ… ç»Ÿä¸€çš„äº‹ä»¶åˆ†å‘æœºåˆ¶
- âœ… æ˜“äºæ·»åŠ æ—¥å¿—ã€æ€§èƒ½ç›‘æ§ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹

---

### 2. æœåŠ¡å™¨ç«¯é‡æ„

#### A. äº‹ä»¶é©±åŠ¨çš„æœåŠ¡é€šä¿¡

**é‡æ„å‰ï¼š**
```csharp
// CharacterServiceImpl.cs
private void NotifyAppearanceUpdate(string roomId, string steamId, byte[] appearanceData)
{
    var roomPlayerIds = _roomManager.GetRoomPlayerIds(roomId);
    foreach (var playerSteamId in roomPlayerIds) {
        var clientContext = _server.GetClientContext(playerSteamId);
        clientContext.Call<ICharacterClientService>()
            .OnPlayerAppearanceUpdated(steamId, appearanceData);
    }
}
```

**é‡æ„åï¼š**
```csharp
// CharacterServiceImpl.cs
public Task<bool> UpdateAppearanceAsync(...)
{
    player.AppearanceData = appearanceData;
    
    // å‘å¸ƒäº‹ä»¶ï¼Œç”±äº‹ä»¶å¤„ç†å™¨è´Ÿè´£é€šçŸ¥
    EventBus.Publish(new PlayerAppearanceUpdatedEvent(steamId, appearanceData));
    return Task.FromResult(true);
}

// Server/EventHandlers/CharacterEventHandler.cs
public class CharacterEventHandler
{
    public void Handle(PlayerAppearanceUpdatedEvent evt)
    {
        var player = _playerManager.GetPlayer(evt.SteamId);
        var room = _roomManager.GetPlayerRoom(evt.SteamId);
        if (room == null) return;
        
        BroadcastToRoom(room.RoomId, evt.SteamId, 
            client => client.Call<ICharacterClientService>()
                .OnPlayerAppearanceUpdated(evt.SteamId, evt.AppearanceData));
    }
}
```

#### B. ç»Ÿä¸€çš„æˆ¿é—´å¹¿æ’­åŸºç±»

```csharp
// Server/Services/BaseRoomService.cs
public abstract class BaseRoomService
{
    protected readonly RpcServer _server;
    protected readonly RoomManager _roomManager;
    protected readonly PlayerManager _playerManager;
    
    protected void BroadcastToRoom(string roomId, string excludeSteamId, 
        Action<IClientContext> action)
    {
        var roomPlayerIds = _roomManager.GetRoomPlayerIds(roomId);
        foreach (var steamId in roomPlayerIds)
        {
            if (steamId == excludeSteamId) continue;
            
            var context = _server.GetClientContext(steamId);
            if (context != null)
            {
                try { action(context); }
                catch (Exception ex) { LogError(...); }
            }
        }
    }
    
    protected bool ValidateClient(IClientContext client, out PlayerInfo? player, 
        out RoomInfo? room)
    {
        // ç»Ÿä¸€çš„éªŒè¯é€»è¾‘
    }
}
```

#### C. ç§»é™¤åå°„ä¾èµ–

**é‡æ„å‰ï¼š**
```csharp
// CharacterServiceImpl ç”¨åå°„è®¿é—® SceneServiceImpl
var playerScenesField = sceneServiceType.GetField("_playerScenes", 
    BindingFlags.NonPublic | BindingFlags.Instance);
```

**é‡æ„åï¼š**
```csharp
// é€šè¿‡äº‹ä»¶è·å–åœºæ™¯ä¿¡æ¯
public class SceneEventHandler
{
    private readonly Dictionary<string, string> _playerScenes = new();
    
    public void Handle(PlayerEnteredSceneEvent evt)
    {
        _playerScenes[evt.PlayerSceneInfo.SteamId] = evt.PlayerSceneInfo.SceneName;
    }
    
    public string? GetPlayerScene(string steamId) => 
        _playerScenes.TryGetValue(steamId, out var scene) ? scene : null;
}
```

---

### 3. å®¢æˆ·ç«¯é‡æ„

#### A. ç»Ÿä¸€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨

```csharp
// Client/Core/NetworkLifecycleManager.cs
public class NetworkLifecycleManager : IDisposable
{
    public event Action? OnConnected;
    public event Action<string>? OnDisconnected;
    public event Action? OnJoinedRoom;
    public event Action? OnLeftRoom;
    
    public async Task HandleConnectedAsync()
    {
        await TryUploadCharacterAsync();
        await InitializeSceneAsync();
        SyncManager.StartSync();
        OnConnected?.Invoke();
    }
    
    public void HandleDisconnected(string reason)
    {
        SyncManager.StopSync();
        SceneManager.OnLeftRoom();
        OnDisconnected?.Invoke(reason);
    }
    
    public async Task HandleJoinedRoomAsync()
    {
        await SceneManager.InitializeRoomDataAsync();
        if (ShouldStartSync()) SyncManager.StartSync();
        OnJoinedRoom?.Invoke();
    }
    
    public void HandleLeftRoom()
    {
        SyncManager.StopSync();
        SceneManager.OnLeftRoom();
        OnLeftRoom?.Invoke();
    }
}
```

#### B. äº‹ä»¶é©±åŠ¨çš„ UI æ›´æ–°

```csharp
// Client/Core/UIManager.cs
public class UIManager : IDisposable
{
    public UIManager(NetworkLifecycleManager lifecycle)
    {
        lifecycle.OnJoinedRoom += () => _roomPage?.Refresh();
        lifecycle.OnLeftRoom += () => _lobbyPage?.Refresh();
        
        // è®¢é˜…èŠå¤©äº‹ä»¶
        EventBus.Subscribe<ChatMessageReceivedEvent>(OnChatMessage);
    }
}
```

---

### 4. é€šç”¨ä¸­é—´ä»¶

#### A. RPC éªŒè¯ä¸­é—´ä»¶

```csharp
// Shared/RPC/RpcMiddleware.cs
public class ValidationMiddleware
{
    public static TResult Execute<TResult>(
        IClientContext client,
        PlayerManager playerManager,
        Func<PlayerInfo, RoomInfo?, TResult> handler)
    {
        if (!playerManager.IsLoggedIn(client.ClientId))
            throw new UnauthorizedAccessException("Not logged in");
            
        var player = playerManager.GetPlayer(client.ClientId);
        if (player == null)
            throw new InvalidOperationException("Player not found");
            
        var room = // è·å–æˆ¿é—´é€»è¾‘...
        
        return handler(player, room);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public Task<bool> UpdateAppearanceAsync(IClientContext client, byte[] data)
{
    return ValidationMiddleware.Execute(
        client, _playerManager,
        (player, room) => {
            // ä¸šåŠ¡é€»è¾‘
            EventBus.Publish(new PlayerAppearanceUpdatedEvent(...));
            return Task.FromResult(true);
        });
}
```

---

## ğŸ“Š é‡æ„å¯¹æ¯”

### ä»£ç è¡Œæ•°å‡å°‘

| æ¨¡å— | é‡æ„å‰ | é‡æ„å | å‡å°‘ |
|------|--------|--------|------|
| CharacterServiceImpl | ~300è¡Œ | ~150è¡Œ | 50% |
| SceneServiceImpl | ~344è¡Œ | ~200è¡Œ | 42% |
| RoomServiceImpl | ~234è¡Œ | ~120è¡Œ | 49% |

### ä¾èµ–å…³ç³»ç®€åŒ–

**é‡æ„å‰ï¼š**
```
CharacterServiceImpl
    â”œâ”€> SceneServiceImpl (åå°„è®¿é—®)
    â”œâ”€> RoomManager
    â””â”€> RpcServer

SceneServiceImpl
    â”œâ”€> RoomManager
    â””â”€> RpcServer
```

**é‡æ„åï¼š**
```
CharacterServiceImpl
    â”œâ”€> PlayerManager
    â””â”€> EventBus (å‘å¸ƒäº‹ä»¶)

CharacterEventHandler
    â”œâ”€> RoomManager
    â””â”€> RpcServer (å¤„ç†é€šçŸ¥)

SceneEventHandler
    â””â”€> EventBus (è®¢é˜…äº‹ä»¶)
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### é˜¶æ®µ 1ï¼šåŸºç¡€è®¾æ–½ (1-2å¤©)
1. âœ… åˆ›å»º `EventBus` ç³»ç»Ÿ
2. âœ… å®šä¹‰æ ¸å¿ƒäº‹ä»¶ç±»å‹
3. âœ… åˆ›å»º `BaseRoomService` åŸºç±»

### é˜¶æ®µ 2ï¼šæœåŠ¡å™¨é‡æ„ (2-3å¤©)
1. âœ… é‡æ„ `CharacterServiceImpl` â†’ ä½¿ç”¨äº‹ä»¶
2. âœ… é‡æ„ `SceneServiceImpl` â†’ ä½¿ç”¨äº‹ä»¶
3. âœ… é‡æ„ `RoomServiceImpl` â†’ ä½¿ç”¨åŸºç±»
4. âœ… åˆ›å»ºäº‹ä»¶å¤„ç†å™¨æ¨¡å—

### é˜¶æ®µ 3ï¼šå®¢æˆ·ç«¯é‡æ„ (1-2å¤©)
1. âœ… åˆ›å»º `NetworkLifecycleManager`
2. âœ… é‡æ„ UI æ¨¡å—ä½¿ç”¨äº‹ä»¶
3. âœ… ç®€åŒ– `ModBehaviour`

### é˜¶æ®µ 4ï¼šæµ‹è¯•ä¸ä¼˜åŒ– (1å¤©)
1. âœ… å•å…ƒæµ‹è¯•
2. âœ… é›†æˆæµ‹è¯•
3. âœ… æ€§èƒ½ä¼˜åŒ–

---

## ğŸ’¡ é¢å¤–ä¼˜åŒ–å»ºè®®

### 1. æœåŠ¡å®šä½å™¨æ¨¡å¼ç®€åŒ–
å°† `GameContext` æ”¹ä¸ºæ›´è½»é‡çš„ä¾èµ–æ³¨å…¥å®¹å™¨ï¼š
```csharp
public class ServiceContainer
{
    private readonly Dictionary<Type, object> _services = new();
    
    public void Register<T>(T instance);
    public T Get<T>();
}
```

### 2. å¼‚æ­¥äº‹ä»¶æ”¯æŒ
ä¸ºæ€§èƒ½æ•æ„Ÿçš„äº‹ä»¶æ·»åŠ å¼‚æ­¥ç‰ˆæœ¬ï¼š
```csharp
public static Task PublishAsync<T>(T eventData) where T : IGameEvent;
```

### 3. äº‹ä»¶è¿‡æ»¤ä¸è·¯ç”±
æ”¯æŒäº‹ä»¶è·¯ç”±åˆ°ç‰¹å®šæˆ¿é—´/åœºæ™¯ï¼š
```csharp
EventBus.Publish(new PlayerAppearanceUpdatedEvent(...), 
    route: Route.ToRoom(roomId));
```

---

## ğŸ“ æ€»ç»“

é€šè¿‡äº‹ä»¶é©±åŠ¨æ¶æ„é‡æ„ï¼š
- âœ… **å‡å°‘ 40-50% ä»£ç é‡**
- âœ… **æ¶ˆé™¤æœåŠ¡é—´ç›´æ¥ä¾èµ–**
- âœ… **ç»Ÿä¸€çš„é€šçŸ¥æœºåˆ¶**
- âœ… **æ›´å¥½çš„å¯æµ‹è¯•æ€§**
- âœ… **æ˜“äºæ‰©å±•æ–°åŠŸèƒ½**

é‡æ„åï¼Œæ·»åŠ æ–°åŠŸèƒ½åªéœ€ï¼š
1. å®šä¹‰äº‹ä»¶ç±»å‹
2. å‘å¸ƒäº‹ä»¶
3. åˆ›å»ºäº‹ä»¶å¤„ç†å™¨

æ— éœ€ä¿®æ”¹ç°æœ‰æœåŠ¡ä»£ç ï¼

