# 角色外观同步功能

## 功能概述

DuckyNet 现在支持完整的角色外观同步功能，包括：
- **自动上传**：角色创建后自动上传外观数据到服务器
- **实时同步**：房间内玩家可以看到其他玩家的角色外观
- **高效压缩**：使用二进制格式传输，数据量仅 100-600 字节
- **持久化存储**：服务器保存玩家外观，跨会话保持

## 技术架构

### 1. 数据结构

#### CharacterAppearanceData（紧凑二进制格式）
```csharp
// 头部设置（18字节）
- 缩放: ScaleX, ScaleY, ScaleZ (6字节)
- 偏移: OffsetX, OffsetY, OffsetZ (6字节)
- 旋转: RotationX, RotationY, RotationZ (6字节)

// 部位数据（21字节/部位）
- PartType: 部位类型 (1字节)
- PartId: 部位ID (2字节)
- 缩放/偏移/旋转: 各6字节
```

**数据压缩效果**：
- JSON 格式：约 2-5KB
- 二进制格式：约 100-600 字节
- **压缩率：75-90%**

### 2. 核心组件

#### CharacterCustomizationManager
负责角色外观的创建和应用：
```csharp
// 获取本地玩家角色
GameObject? GetLocalPlayerCharacter()

// 从角色提取外观数据
object? GetCustomizationFromCharacter(object character)

// 应用外观到角色
void ApplyToCharacter(object character, object customData)
```

#### CharacterAppearanceConverter
在游戏数据和网络数据之间转换：
```csharp
// 游戏数据 -> 网络数据
CharacterAppearanceData? ConvertToNetworkData(object gameCustomData)

// 网络数据 -> 游戏数据
object? ConvertToGameData(CharacterAppearanceData networkData)
```

#### CharacterAppearanceHelper
提供高级API：
```csharp
// 上传当前角色外观
Task<bool> UploadCurrentAppearanceAsync()

// 下载指定玩家外观
Task<CharacterAppearanceData?> DownloadAppearanceAsync(string steamId)

// 启动自动上传监听
void StartAutoUpload()
```

### 3. 服务端接口

#### ICharacterService
```csharp
// 更新玩家外观（最大10KB）
Task<bool> UpdateAppearanceAsync(IClientContext client, byte[] appearanceData)

// 获取玩家外观
Task<byte[]?> GetAppearanceAsync(IClientContext client, string steamId)

// 标记角色已创建
Task<bool> SetCharacterCreatedAsync(IClientContext client, bool hasCharacter)
```

#### ICharacterClientService
```csharp
// 外观更新通知
void OnPlayerAppearanceUpdated(string steamId, byte[] appearanceData)
```

## 工作流程

### 自动上传流程

```
1. 玩家进入游戏
   ↓
2. ModBehaviour 初始化
   ↓
3. CharacterAppearanceHelper.StartAutoUpload() 订阅事件
   ↓
4. 关卡加载完成 (OnLevelInitialized)
   ↓
5. 延迟 1 秒确保角色完全加载
   ↓
6. 自动调用 UploadCurrentAppearanceAsync()
   ↓
7. 提取外观 -> 转换 -> 压缩 -> 上传
   ↓
8. 服务器保存并通知房间内其他玩家
```

### 手动上传流程

```csharp
// 手动上传当前角色外观
bool success = await CharacterAppearanceHelper.UploadCurrentAppearanceAsync();
if (success)
{
    Debug.Log("外观上传成功");
}
```

### 场景同步流程

```
1. 玩家A进入场景
   ↓
2. SceneManager 请求场景内所有玩家数据
   ↓
3. 服务器返回玩家B的信息（包含外观数据）
   ↓
4. SceneManager 创建玩家B的模型
   ↓
5. 解压外观数据 -> 转换 -> 应用到模型
   ↓
6. 玩家A看到玩家B的正确外观
```

### 实时更新流程

```
1. 玩家A修改外观并上传
   ↓
2. 服务器接收并保存
   ↓
3. 服务器通知房间内所有玩家（除玩家A）
   ↓
4. SceneManager.UpdatePlayerAppearance() 被调用
   ↓
5. 如果玩家A在当前场景，更新其模型外观
   ↓
6. 其他玩家实时看到玩家A的新外观
```

## 使用示例

### 客户端示例

```csharp
// 1. 自动上传（已在 ModBehaviour 中启用）
// 无需手动调用，角色创建后自动上传

// 2. 手动上传
if (GameContext.IsInitialized)
{
    bool success = await CharacterAppearanceHelper.UploadCurrentAppearanceAsync();
    Debug.Log($"外观上传: {(success ? "成功" : "失败")}");
}

// 3. 下载其他玩家外观
string targetSteamId = "76561198012345678";
var appearanceData = await CharacterAppearanceHelper.DownloadAppearanceAsync(targetSteamId);
if (appearanceData != null)
{
    Debug.Log($"下载外观成功: {appearanceData.Parts.Length} 个部位");
}

// 4. 应用外观到角色
var customizationManager = GameContext.Instance.CharacterCustomizationManager;
var converter = new CharacterAppearanceConverter();
var gameData = converter.ConvertToGameData(appearanceData);
customizationManager.ApplyToCharacter(characterObject, gameData);
```

### 服务端示例

```csharp
// 服务端自动处理，无需额外代码
// CharacterServiceImpl 会：
// 1. 接收和保存外观数据
// 2. 验证数据大小（最大10KB）
// 3. 通知房间内其他玩家
```

## 数据持久化

### 客户端
```csharp
// LocalPlayer.Info.AppearanceData
// 保存本地玩家的外观数据副本
byte[]? appearanceData = localPlayer.Info.AppearanceData;
```

### 服务端
```csharp
// PlayerInfo.AppearanceData
// 服务器保存每个玩家的外观数据
// 在玩家断线重连后仍然保持
```

## 性能优化

### 1. 数据压缩
- 使用 Int16 压缩浮点数（精度 0.01，范围 ±327.68）
- 典型外观数据：100-600 字节
- 比 JSON 小 **75-90%**

### 2. 延迟上传
```csharp
// 延迟 1 秒确保角色完全加载
await Task.Delay(1000);
```

### 3. 按需同步
- 只在同一场景的玩家之间同步
- 进入场景时批量获取，而非逐个请求

### 4. 增量更新
- 外观修改时只发送新数据
- 不重复发送未改变的部分

## 调试和日志

### 启用详细日志
所有关键操作都有日志输出，便于调试：

```
[CharacterAppearanceHelper] 外观数据大小: 387 bytes
[CharacterAppearanceHelper] 外观上传成功
[CharacterService] 外观已更新 (387 bytes) - Player(76561198012345678)
[CharacterService] 已通知 3 个玩家外观更新
[SceneManager] 更新玩家外观: 76561198012345678 (387 bytes)
[SceneManager] 外观已应用: 76561198012345678
```

### 常见问题排查

**问题：自动上传失败**
```
原因：角色未完全加载
解决：增加延迟时间或手动调用上传
```

**问题：外观数据过大**
```
原因：部位数量过多
解决：服务器限制最大 10KB，应该足够
```

**问题：外观不同步**
```
原因：玩家不在同一场景或房间
解决：检查场景和房间状态
```

## 扩展开发

### 自定义外观数据
如需支持额外的外观属性，修改 `CharacterAppearanceData.cs`：

```csharp
[Serializable]
public class CharacterAppearanceData
{
    public HeadSettingData HeadSetting { get; set; }
    public PartData[] Parts { get; set; }
    
    // 添加新属性
    public byte SkinColor { get; set; }
    public byte EyeColor { get; set; }
}
```

### 添加外观修改监听
如需监听玩家修改外观，可以 Patch 相关方法：

```csharp
[HarmonyPatch(typeof(CharacterModel), "SetFaceFromData")]
class CharacterModelPatch
{
    static void Postfix(CharacterModel __instance)
    {
        // 外观已修改，触发上传
        _ = CharacterAppearanceHelper.UploadCurrentAppearanceAsync();
    }
}
```

## 总结

角色外观同步功能已完整实现，包括：

✅ 自动上传角色外观  
✅ 实时同步到房间内其他玩家  
✅ 高效二进制压缩（75-90% 压缩率）  
✅ 服务器持久化存储  
✅ 场景进入时批量加载  
✅ 实时更新通知机制  

系统完全自动化，无需手动干预！

