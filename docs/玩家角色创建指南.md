# 玩家角色创建指南

本文档详细说明了在 Duckov 游戏中如何创建和管理玩家角色单位。

## 目录

- [核心架构](#核心架构)
- [关键类说明](#关键类说明)
- [创建流程](#创建流程)
- [代码示例](#代码示例)
- [在 DuckyNet 中应用](#在-duckynet-中应用)

---

## 核心架构

### 角色组成三要素

在 Duckov 中，一个完整的角色由三个核心部分组成：

```
角色 (Character) = Item + CharacterModel + CharacterMainControl
```

1. **Item（ItemStatsSystem.Item）**
   - 角色的数据容器
   - 存储属性（血量、速度、耐力等）
   - 管理背包（Inventory）
   - 管理装备槽位（Slots）
   - 位置：`F:/duckovsrc-main/ItemStatsSystem/ItemStatsSystem/Item.cs`

2. **CharacterModel（UnityEngine.GameObject）**
   - 3D 模型和视觉表现
   - 动画控制器
   - 骨骼绑定点（手部、头部等）
   - 位置：`F:/duckovsrc-main/TeamSoda.Duckov.Core/CharacterModel.cs`

3. **CharacterMainControl（MonoBehaviour）**
   - 角色行为控制器
   - 输入处理
   - 移动、战斗、交互逻辑
   - 位置：`F:/duckovsrc-main/TeamSoda.Duckov.Core/CharacterMainControl.cs`

---

## 关键类说明

### 1. CharacterCreator

**位置：** `F:/duckovsrc-main/TeamSoda.Duckov.Core/CharacterCreator.cs`

**作用：** 角色创建的核心工厂类

**关键方法：**

```csharp
public async UniTask<CharacterMainControl> CreateCharacter(
    Item itemInstance,           // 角色数据 Item
    CharacterModel modelPrefab,  // 角色模型预制体
    Vector3 pos,                 // 生成位置
    Quaternion rotation          // 初始旋转
)
{
    // 1. 实例化角色控制器预制体
    CharacterMainControl characterMainControl = Object.Instantiate(characterPfb, pos, rotation);
    
    // 2. 实例化角色模型
    CharacterModel characterModel = Object.Instantiate(modelPrefab);
    
    // 3. 绑定模型到控制器
    characterMainControl.SetCharacterModel(characterModel);
    
    // 4. 绑定数据 Item
    characterMainControl.SetItem(itemInstance);
    
    // 5. 添加基础 Buff（如果不在突袭地图）
    if (!LevelManager.Instance.IsRaidMap)
    {
        characterMainControl.AddBuff(GameplayDataSettings.Buffs.BaseBuff);
    }
    
    return characterMainControl;
}
```

**辅助方法：**

```csharp
public async UniTask<Item> LoadOrCreateCharacterItemInstance(int itemTypeID)
{
    return await ItemAssetsCollection.InstantiateAsync(itemTypeID);
}
```

---

### 2. LevelManager

**位置：** `F:/duckovsrc-main/TeamSoda.Duckov.Core/LevelManager.cs`

**作用：** 场景管理器，负责主角色的创建和生命周期管理

**主角色创建方法：**

```csharp
private async UniTask CreateMainCharacterAsync(Vector3 position, Quaternion rotation)
{
    // 1. 加载或创建角色 Item 实例
    Item itemInstance = await LoadOrCreateCharacterItemInstance();
    
    // 2. 通过 CharacterCreator 创建角色
    mainCharacter = await characterCreator.CreateCharacter(
        itemInstance, 
        characterModel, 
        position, 
        rotation
    );
    
    if (!(mainCharacter == null))
    {
        // 3. 清理基地中需要销毁的物品
        if (IsBaseLevel)
        {
            mainCharacter.DestroyItemsThatNeededToBeDestriedInBase();
        }
        
        // 4. 设置为玩家队伍
        mainCharacter.SetTeam(Teams.player);
        
        // 5. 配置背包
        mainCharacter.CharacterItem.Inventory.AcceptSticky = true;
        
        // 6. 设置默认技能
        if (defaultSkill != null)
        {
            SkillBase skillBase = UnityEngine.Object.Instantiate(defaultSkill);
            skillBase.transform.SetParent(mainCharacter.transform, worldPositionStays: false);
            mainCharacter.SetSkill(SkillTypes.characterSkill, skillBase, skillBase.gameObject);
        }
        
        // 7. 绑定输入管理器
        inputManager.characterMainControl = mainCharacter;
        inputManager.SwitchItemAgent(1);
        
        // 8. 设置相机目标
        gameCamera.SetTarget(mainCharacter);
    }
}
```

**Item 加载方法：**

```csharp
private async UniTask<Item> LoadOrCreateCharacterItemInstance()
{
    // 尝试从存档加载
    Item item = await ItemSavesUtilities.LoadItem("MainCharacterItemData");
    
    // 如果加载失败，创建新的
    if (item == null)
    {
        item = await ItemAssetsCollection.InstantiateAsync(characterItemTypeID);
        Debug.LogWarning("Item Loading failed");
    }
    
    return item;
}
```

---

### 3. CharacterRandomPreset

**位置：** `F:/duckovsrc-main/TeamSoda.Duckov.Core/CharacterRandomPreset.cs`

**作用：** NPC/敌人角色的预设配置和创建

**创建方法：**

```csharp
public async UniTask<CharacterMainControl> CreateCharacterAsync(
    Vector3 pos,                      // 生成位置
    Vector3 dir,                      // 朝向方向
    int relatedScene,                 // 关联场景索引
    CharacterSpawnerGroup group,      // 生成组（可选）
    bool isLeader                     // 是否为队长
)
{
    // 1. 创建角色 Item 实例
    Item characterItemInstance = await LevelManager.Instance.CharacterCreator
        .LoadOrCreateCharacterItemInstance(characterItemTypeID);
    
    // 2. 设置基础属性
    characterItemInstance.GetStat("MaxHealth".GetHashCode()).BaseValue = 
        health * LevelManager.Rule.EnemyHealthFactor;
    characterItemInstance.SetInt("Exp", exp);
    
    // 3. 设置随机属性
    for (int i = 0; i < setStats.Count; i++)
    {
        SetCharacterStatInfo statInfo = setStats[i];
        SetCharacterStat(
            statInfo.statName, 
            UnityEngine.Random.Range(statInfo.statBaseValue.x, statInfo.statBaseValue.y)
        );
    }
    
    // 4. 设置元素属性
    SetCharacterStat("ElementFactor_Physics", elementFactor_Physics);
    SetCharacterStat("ElementFactor_Fire", elementFactor_Fire);
    SetCharacterStat("ElementFactor_Poison", elementFactor_Poison);
    // ... 更多属性
    
    // 5. 生成初始装备
    List<Item> initialItems = await GenerateItems();
    
    // 6. 创建角色
    CharacterMainControl character = await LevelManager.Instance.CharacterCreator
        .CreateCharacter(
            characterItemInstance, 
            characterModel, 
            pos, 
            Quaternion.LookRotation(dir, Vector3.up)
        );
    
    // 7. 配置 AI 控制器（如果有）
    if ((bool)aiController)
    {
        AICharacterController ai = UnityEngine.Object.Instantiate(aiController);
        ai.Init(character, pos, voiceType, footstepMaterialType);
        // ... 设置 AI 参数
    }
    
    // 8. 添加初始物品到背包
    foreach (Item item in initialItems)
    {
        characterItemInstance.Inventory.AddAndMerge(item);
    }
    
    return character;
}
```

---

## 创建流程

### 完整流程图

```
开始
  ↓
创建/加载 Item 实例
  ↓
设置 Item 属性（血量、属性等）
  ↓
调用 CharacterCreator.CreateCharacter()
  ├─ 实例化角色控制器预制体
  ├─ 实例化角色模型
  ├─ 绑定模型到控制器
  └─ 绑定 Item 数据
  ↓
设置队伍（Teams.player / Teams.enemy 等）
  ↓
配置背包和装备
  ↓
设置技能
  ↓
绑定输入控制（仅玩家）
  ↓
设置相机目标（仅玩家）
  ↓
完成
```

---

## 代码示例

### 示例 1：创建主玩家角色

```csharp
using Cysharp.Threading.Tasks;
using ItemStatsSystem;
using UnityEngine;

public class PlayerSpawner : MonoBehaviour
{
    [SerializeField] private CharacterCreator characterCreator;
    [SerializeField] private CharacterModel playerModelPrefab;
    [SerializeField] private Vector3 spawnPosition = Vector3.zero;
    
    public async UniTask<CharacterMainControl> SpawnMainPlayer()
    {
        try
        {
            // 1. 获取角色 Item Type ID
            int characterItemTypeID = GameplayDataSettings.ItemAssets.DefaultCharacterItemTypeID;
            
            // 2. 创建角色数据 Item
            Item characterItem = await ItemAssetsCollection.InstantiateAsync(characterItemTypeID);
            
            // 3. 设置基础属性
            characterItem.GetStat("MaxHealth".GetHashCode()).BaseValue = 100f;
            characterItem.GetStat("WalkSpeed".GetHashCode()).BaseValue = 3.5f;
            characterItem.GetStat("RunSpeed".GetHashCode()).BaseValue = 6.0f;
            characterItem.GetStat("Stamina".GetHashCode()).BaseValue = 100f;
            
            // 4. 创建角色
            CharacterMainControl player = await characterCreator.CreateCharacter(
                characterItem,
                playerModelPrefab,
                spawnPosition,
                Quaternion.identity
            );
            
            // 5. 配置为玩家
            player.SetTeam(Teams.player);
            player.CharacterItem.Inventory.AcceptSticky = true;
            player.CharacterItem.Inventory.SetCapacity(16);
            
            Debug.Log($"[PlayerSpawner] 玩家创建成功: {player.name}");
            return player;
        }
        catch (System.Exception ex)
        {
            Debug.LogError($"[PlayerSpawner] 玩家创建失败: {ex.Message}");
            return null;
        }
    }
}
```

### 示例 2：创建 NPC 角色

```csharp
using Cysharp.Threading.Tasks;
using ItemStatsSystem;
using UnityEngine;

public class NPCSpawner : MonoBehaviour
{
    [SerializeField] private CharacterRandomPreset npcPreset;
    
    public async UniTask<CharacterMainControl> SpawnNPC(Vector3 position, Vector3 forward)
    {
        try
        {
            // 使用预设创建 NPC
            CharacterMainControl npc = await npcPreset.CreateCharacterAsync(
                position,           // 生成位置
                forward,            // 朝向
                0,                  // 场景索引
                null,               // 不属于任何生成组
                false               // 不是队长
            );
            
            Debug.Log($"[NPCSpawner] NPC 创建成功: {npc.name}");
            return npc;
        }
        catch (System.Exception ex)
        {
            Debug.LogError($"[NPCSpawner] NPC 创建失败: {ex.Message}");
            return null;
        }
    }
}
```

### 示例 3：创建简单的测试角色（无预设）

```csharp
using Cysharp.Threading.Tasks;
using ItemStatsSystem;
using UnityEngine;

public class TestCharacterSpawner : MonoBehaviour
{
    public async UniTask<CharacterMainControl> CreateTestCharacter(
        string characterName,
        Vector3 position,
        Teams team = Teams.neutral
    )
    {
        try
        {
            // 1. 获取核心组件
            CharacterCreator creator = LevelManager.Instance.CharacterCreator;
            
            // 2. 创建角色 Item
            int itemTypeID = GameplayDataSettings.ItemAssets.DefaultCharacterItemTypeID;
            Item characterItem = await ItemAssetsCollection.InstantiateAsync(itemTypeID);
            
            // 3. 设置最小属性
            characterItem.GetStat("MaxHealth".GetHashCode()).BaseValue = 50f;
            
            // 4. 获取默认模型
            CharacterModel defaultModel = GameplayDataSettings.Prefabs.CharacterModel;
            
            // 5. 创建角色
            CharacterMainControl character = await creator.CreateCharacter(
                characterItem,
                defaultModel,
                position,
                Quaternion.identity
            );
            
            // 6. 配置角色
            character.name = characterName;
            character.SetTeam(team);
            character.Health.Init();
            
            Debug.Log($"[TestSpawner] 测试角色创建成功: {characterName}");
            return character;
        }
        catch (System.Exception ex)
        {
            Debug.LogError($"[TestSpawner] 创建失败: {ex.Message}");
            return null;
        }
    }
}
```

---

## 在 DuckyNet 中应用

### DebugWindow 集成示例

基于你的 `Client/UI/DebugWindow.cs`，以下是完整的集成方案：

```csharp
using System;
using System.Collections.Generic;
using UnityEngine;
using DuckyNet.Client.RPC;
using Cysharp.Threading.Tasks;
using ItemStatsSystem;

namespace DuckyNet.Client.UI
{
    public class DebugWindow : IUIWindow
    {
        private readonly RpcClient _client;
        private Rect _windowRect = new Rect(Screen.width - 420, 100, 400, 500);
        private bool _isVisible = false;
        private Vector2 _scrollPosition = Vector2.zero;

        // 测试用的玩家创建参数
        private string _testPlayerName = "TestPlayer";
        private Vector3 _testPlayerPosition = Vector3.zero;
        
        // 调试信息
        private string _debugLog = "";
        private const int MAX_LOG_LINES = 15;
        
        // 存储创建的测试单位
        private List<CharacterMainControl> _testCharacters = new List<CharacterMainControl>();

        // ... 其他代码保持不变 ...

        /// <summary>
        /// 创建空白玩家单位
        /// </summary>
        private async void CreateBlankPlayerUnit()
        {
            try
            {
                LogDebug($"[创建] 开始创建单位: {_testPlayerName}");
                
                // 1. 检查 LevelManager 是否存在
                if (LevelManager.Instance == null)
                {
                    LogDebug("[错误] LevelManager 未初始化");
                    return;
                }
                
                // 2. 获取 CharacterCreator
                CharacterCreator creator = LevelManager.Instance.CharacterCreator;
                if (creator == null)
                {
                    LogDebug("[错误] CharacterCreator 未找到");
                    return;
                }
                
                LogDebug("[创建] 正在创建角色 Item...");
                
                // 3. 创建角色 Item 实例
                int itemTypeID = GameplayDataSettings.ItemAssets.DefaultCharacterItemTypeID;
                Item characterItem = await ItemAssetsCollection.InstantiateAsync(itemTypeID);
                
                if (characterItem == null)
                {
                    LogDebug("[错误] 角色 Item 创建失败");
                    return;
                }
                
                // 4. 设置基础属性
                characterItem.GetStat("MaxHealth".GetHashCode()).BaseValue = 100f;
                characterItem.GetStat("WalkSpeed".GetHashCode()).BaseValue = 3.5f;
                characterItem.GetStat("RunSpeed".GetHashCode()).BaseValue = 6.0f;
                
                LogDebug("[创建] 正在实例化角色...");
                
                // 5. 获取角色模型预制体
                CharacterModel modelPrefab = GameplayDataSettings.Prefabs.CharacterModel;
                if (modelPrefab == null)
                {
                    LogDebug("[错误] 角色模型预制体未找到");
                    return;
                }
                
                // 6. 创建角色
                CharacterMainControl newCharacter = await creator.CreateCharacter(
                    characterItem,
                    modelPrefab,
                    _testPlayerPosition,
                    Quaternion.identity
                );
                
                if (newCharacter == null)
                {
                    LogDebug("[错误] 角色创建失败");
                    return;
                }
                
                // 7. 配置角色
                newCharacter.name = _testPlayerName;
                newCharacter.SetTeam(Teams.neutral);  // 设置为中立队伍
                newCharacter.Health.Init();
                
                // 8. 添加到测试单位列表
                _testCharacters.Add(newCharacter);
                
                LogDebug($"[成功] 单位已创建: {_testPlayerName} (ID: {newCharacter.GetInstanceID()})");
                LogDebug($"  位置: {_testPlayerPosition}");
                LogDebug($"  血量: {newCharacter.Health.MaxHealth}");
                
                Debug.Log($"[DebugWindow] 创建成功: {_testPlayerName} at {_testPlayerPosition}");
            }
            catch (Exception ex)
            {
                LogDebug($"[异常] {ex.Message}");
                Debug.LogError($"[DebugWindow] 创建失败: {ex}");
            }
        }

        /// <summary>
        /// 销毁所有测试单位
        /// </summary>
        private void DestroyAllTestUnits()
        {
            try
            {
                int destroyedCount = 0;
                
                foreach (var character in _testCharacters)
                {
                    if (character != null)
                    {
                        UnityEngine.Object.Destroy(character.gameObject);
                        destroyedCount++;
                    }
                }
                
                _testCharacters.Clear();
                
                LogDebug($"[销毁] 已销毁 {destroyedCount} 个测试单位");
                Debug.Log($"[DebugWindow] 销毁了 {destroyedCount} 个测试单位");
            }
            catch (Exception ex)
            {
                LogDebug($"[错误] 销毁失败: {ex.Message}");
                Debug.LogError($"[DebugWindow] 销毁失败: {ex.Message}");
            }
        }

        /// <summary>
        /// 记录调试信息
        /// </summary>
        public void LogDebug(string message)
        {
            string timestamp = DateTime.Now.ToString("HH:mm:ss");
            _debugLog += $"[{timestamp}] {message}\n";
            
            // 限制日志行数
            var lines = _debugLog.Split('\n');
            if (lines.Length > MAX_LOG_LINES)
            {
                _debugLog = string.Join("\n", lines, lines.Length - MAX_LOG_LINES, MAX_LOG_LINES);
            }
        }
    }
}
```

### 使用说明

1. **调用时机**：确保在 `LevelManager` 初始化完成后调用
2. **权限检查**：根据需要添加权限检查（仅服务器/管理员）
3. **网络同步**：如果需要多人看到，需要通过 RPC 同步创建
4. **资源清理**：场景切换时记得清理测试单位

---

## 重要属性说明

### Item 中的关键属性

```csharp
// 基础属性
"MaxHealth"          // 最大生命值
"WalkSpeed"          // 行走速度
"RunSpeed"           // 奔跑速度
"Stamina"            // 耐力值
"MaxWeight"          // 最大负重

// 战斗属性
"GunDamageMultiplier"      // 枪械伤害倍率
"MeleeDamageMultiplier"    // 近战伤害倍率
"GunCritRateGain"          // 暴击率增益
"ReloadSpeedGain"          // 装弹速度增益

// 移动属性
"DashSpeed"          // 冲刺速度
"TurnSpeed"          // 转身速度
"Moveability"        // 移动能力

// 感知属性
"ViewDistance"       // 视野距离
"ViewAngle"          // 视野角度
"HearingAbility"     // 听力能力
"NightVisionAbility" // 夜视能力
```

### Teams 枚举

```csharp
public enum Teams
{
    player,      // 玩家
    enemy,       // 敌人
    scav,        // 拾荒者
    neutral,     // 中立
    merchant,    // 商人
    pet          // 宠物
}
```

---

## 常见问题

### Q1: 角色创建后看不见？

**A:** 检查以下几点：
- 模型是否正确绑定：`characterMainControl.SetCharacterModel()`
- 相机是否设置：`gameCamera.SetTarget(character)`
- 是否在正确的场景中：`MultiSceneCore.MoveToMainScene()`

### Q2: 角色没有血量？

**A:** 确保调用了：
```csharp
characterItem.GetStat("MaxHealth".GetHashCode()).BaseValue = 100f;
character.Health.Init();
```

### Q3: 角色无法移动？

**A:** 检查：
- 是否设置了移动速度属性
- `Movement` 组件是否正确初始化
- 是否有输入控制（玩家需要）

### Q4: 异步创建导致的空引用？

**A:** 使用 `async/await` 确保顺序：
```csharp
Item item = await ItemAssetsCollection.InstantiateAsync(itemTypeID);
if (item == null) return;  // 检查是否创建成功

CharacterMainControl character = await creator.CreateCharacter(...);
if (character == null) return;  // 检查是否创建成功
```

---

## 参考资料

### 源代码位置

- **CharacterCreator**: `F:/duckovsrc-main/TeamSoda.Duckov.Core/CharacterCreator.cs`
- **CharacterMainControl**: `F:/duckovsrc-main/TeamSoda.Duckov.Core/CharacterMainControl.cs`
- **CharacterRandomPreset**: `F:/duckovsrc-main/TeamSoda.Duckov.Core/CharacterRandomPreset.cs`
- **LevelManager**: `F:/duckovsrc-main/TeamSoda.Duckov.Core/LevelManager.cs`
- **Item**: `F:/duckovsrc-main/ItemStatsSystem/ItemStatsSystem/Item.cs`

### 相关系统

- **ItemStatsSystem**: 属性和物品系统
- **AICharacterController**: AI 控制系统
- **Health**: 生命值管理系统
- **Movement**: 移动控制系统

---

